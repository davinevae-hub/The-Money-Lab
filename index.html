<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Money Lab ‚Äî Tap Card Money Game</title>
  <style>
    :root{
      --bg:#070a16;
      --panel:#101834;
      --panel2:#0c1228;
      --text:#eef1ff;
      --muted:#aab3da;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --good:#5ee6a8;
      --bad:#ff6b7a;
      --warn:#ffd36a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(7,10,22,.75);
      border-bottom: 1px solid var(--line);
      padding: 14px 16px;
    }
    header .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      max-width: 1100px; margin:0 auto;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35; }
    main{ max-width:1100px; margin:0 auto; padding: 16px; }

    .hud{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-bottom: 14px;
    }
    @media (max-width: 980px){
      .hud{ grid-template-columns: repeat(3, 1fr); }
    }
    .kpi{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 62px;
    }
    .kpi .t{ font-size:11px; color:var(--muted); }
    .kpi .v{ margin-top:6px; font-weight:900; letter-spacing:.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }
    .warn{ color: var(--warn); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card{
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      padding: 14px;
    }

    .bigTitle{ font-size: 18px; font-weight: 950; margin: 0 0 6px; }
    .bigBody{ color: var(--muted); line-height: 1.4; }

    .badge{
      display:inline-block;
      margin-left:8px;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.12);
      color: var(--text);
      font-size: 11px;
      font-weight: 900;
    }

    .choiceGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (min-width: 860px){
      .choiceGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    button{
      border-radius: 16px;
      border:1px solid rgba(122,162,255,.65);
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      color: var(--text);
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      width:100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-align:left;
    }
    button.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight: 800;
    }
    button.danger{
      border-color: rgba(255,107,122,.65);
      background: linear-gradient(180deg, rgba(255,107,122,.95), rgba(255,107,122,.70));
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btnRow .half{ flex:1 1 220px; }
    .btnRow .third{ flex:1 1 160px; }

    input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    input:focus{
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }

    .progressWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
      height: 10px;
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(94,230,168,.95), rgba(122,162,255,.95));
    }

    .tip{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      max-height: 420px;
      overflow:auto;
    }

    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    .pill{
      display:inline-block;
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      font-size: 12px;
      font-weight: 900;
      margin-right: 8px;
    }
    .small{ font-size:12px; color: var(--muted); }

    details{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.14);
      margin-top: 10px;
    }
    summary{ cursor:pointer; font-weight: 900; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      border:1px solid rgba(255,255,255,.16);
      border-radius: 8px;
      padding: 1px 6px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Money Lab <span class="badge">Tap Card Game</span></h1>
      <div class="sub">
        Fast rounds. Quick choices. Instant results.<br/>
        Goal: build a strong <strong>Money Score</strong> by learning to earn, save, invest, and avoid debt.
      </div>
    </div>
    <div style="width:300px; max-width:46vw;">
      <div class="sub" style="margin-bottom:6px;">Name</div>
      <input id="playerName" type="text" value="Player 1" />
      <div class="sub" style="margin-top:8px;">Seed (optional, same results each time)</div>
      <input id="seed" type="text" placeholder="e.g., 2026" />
    </div>
  </div>
</header>

<main>
  <section class="hud" aria-label="HUD">
    <div class="kpi"><div class="t">Round</div><div class="v" id="kRound">‚Äî</div></div>
    <div class="kpi"><div class="t">Level</div><div class="v" id="kLevel">‚Äî</div></div>
    <div class="kpi"><div class="t">Cash (now)</div><div class="v" id="kCash">‚Äî</div></div>
    <div class="kpi"><div class="t">Savings (safe)</div><div class="v" id="kSave">‚Äî</div></div>
    <div class="kpi"><div class="t">Invest (can grow)</div><div class="v" id="kInv">‚Äî</div></div>
    <div class="kpi"><div class="t">Debt / Money Score</div><div class="v" id="kDebtScore">‚Äî</div></div>
  </section>

  <div class="grid">
    <!-- GAME PANEL -->
    <section class="panel" aria-label="Game">
      <div class="card" id="gameCard"></div>

      <details>
        <summary>How to play (simple)</summary>
        <div class="small" style="margin-top:8px; line-height:1.45;">
          Each round is one ‚Äúmoney moment.‚Äù You will:
          <ol style="margin:8px 0 0 18px;">
            <li>Get paid</li>
            <li>Pay the must-pays</li>
            <li>Tap one plan (Save / Balanced / Bold)</li>
            <li>Get a surprise card</li>
            <li>See your Money Score change</li>
          </ol>
          Tips show up in one sentence. Try to build a <strong>streak</strong>.
          You can save your game and come back later.
        </div>
      </details>

      <div class="btnRow">
        <button class="secondary third" id="btnSkill">Level up money skills</button>
        <button class="secondary third" id="btnSave">Save</button>
        <button class="secondary third" id="btnLoad">Load</button>
        <button class="danger third" id="btnReset">Reset</button>
      </div>
    </section>

    <!-- JOURNAL PANEL -->
    <section class="panel" aria-label="Journal">
      <div class="card">
        <div class="pill" id="pillStreak">Streak: 0</div>
        <div class="pill" id="pillGoal">Goal: 20 rounds</div>
        <div class="progressWrap" aria-label="Progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="tip" id="tipBox">Tip: Save a little first. Future you will be grateful.</div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h2 style="margin:0 0 8px;">Ledger</h2>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
    </section>
  </div>
</main>

<script>
/* =========================================================
   MONEY LAB ‚Äî TAP CARD GAME
   - Short attention span design
   - One-tap plans (no math required)
   - Teaches by cause ‚Üí effect
   - 20 rounds, streak + level system
   - Single file, GitHub Pages friendly
========================================================= */

/* ---------- Core settings ---------- */
const TOTAL_ROUNDS = 20;

// ‚ÄúMust-pays‚Äù include simplified ‚Äútax + basics‚Äù as one number.
// This keeps the game fast while still teaching ‚Äúyou don‚Äôt keep all your pay.‚Äù
const MUST_PAY_MIN = 35;      // lower bound of must-pays
const MUST_PAY_MAX = 95;      // upper bound of must-pays

// Savings grows safely each round (slow).
const SAVINGS_GROWTH = 0.01;  // 1% per round

// Investment base change is random; skill level slightly improves it.
const INV_MIN = -0.06;        // -6%
const INV_MAX =  0.12;        // +12%

// Debt hurts. It grows a bit each round (interest).
const DEBT_INTEREST = 0.03;   // 3% per round

// Leveling
const LEVELS = [
  { name: "Rookie",    perk: "No perk yet. You‚Äôre learning.",               cost: 0 },
  { name: "Saver",     perk: "Bad surprises cost a little less.",          cost: 250 },
  { name: "Planner",   perk: "You get a small safety cushion each round.", cost: 350 },
  { name: "Investor",  perk: "Your invest results are slightly better.",   cost: 450 },
  { name: "Boss",      perk: "You lose less on bad luck days.",            cost: 600 }
];

/* ---------- Utility ---------- */
const fmt = (n) => {
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 0 });
};

function mulberry32(a){
  return function(){
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function getRng(){
  const s = document.getElementById("seed").value.trim();
  if(!s) return Math.random;
  const n = Number(s);
  if(!Number.isFinite(n)) return Math.random;
  return mulberry32(n >>> 0);
}

function rint(rng, min, max){
  return Math.floor(rng() * (max - min + 1)) + min;
}

function rfloat(rng, min, max){
  return rng() * (max - min) + min;
}

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* ---------- Game content (simple language) ---------- */
const paychecks = [
  { name: "Babysitting", min: 60, max: 140 },
  { name: "Part-time shift", min: 90, max: 180 },
  { name: "Gig job", min: 50, max: 220 },
  { name: "Small hustle", min: 40, max: 260 },
  { name: "Weekend work", min: 80, max: 210 }
];

const surprises = [
  { name: "Phone screen cracked", kind:"cash", min:-70, max:-30, tip:"Stuff breaks. Savings helps." },
  { name: "Friend invites you out", kind:"choice", cost:25, tip:"Fun is fine ‚Äî plan for it." },
  { name: "Lost something (replace it)", kind:"cash", min:-45, max:-15, tip:"Small leaks add up." },
  { name: "You got a small bonus", kind:"cash", min:25, max:80, tip:"Don‚Äôt blow wins ‚Äî build wins." },
  { name: "Market dip", kind:"market", min:-0.08, max:-0.03, tip:"Investing goes down sometimes. That‚Äôs normal." },
  { name: "Market pop", kind:"market", min:0.03, max:0.10, tip:"Good days happen. Don‚Äôt get reckless." },
  { name: "Someone pays you back", kind:"cash", min:20, max:65, tip:"When money returns, save some." },
  { name: "Emergency fee", kind:"cash", min:-60, max:-20, tip:"Unexpected bills are real. Buffer matters." }
];

const microTips = [
  "Save a little first. Future you will be grateful.",
  "Debt grows if you ignore it.",
  "Investing can go up or down. That‚Äôs normal.",
  "A plan beats vibes every time.",
  "Cash is for now. Savings is for later.",
  "If you have no buffer, one surprise can wreck you."
];

/* ---------- State ---------- */
let state = null;
let ui = { phase: "start", draft: null }; // phases: start, paid, plan, surprise, results, end

const STORAGE_KEY = "moneyLabTapCardSave_v1";

/* ---------- Helpers ---------- */
function levelIndex(){ return clamp(state.level, 0, LEVELS.length - 1); }
function levelName(){ return LEVELS[levelIndex()].name; }
function moneyScore(){
  // Simple score that rewards assets and penalizes debt.
  // Not ‚Äúnet worth wording‚Äù ‚Äî just ‚Äúscore‚Äù.
  return Math.round((state.cash + state.savings + state.invest) - (state.debt * 1.2) + (state.streak * 10));
}

function log(line){
  state.log.push(line);
  const el = document.getElementById("log");
  el.textContent = state.log.join("\n");
  el.scrollTop = el.scrollHeight;
}

function setTip(text){
  document.getElementById("tipBox").textContent = "Tip: " + text;
}

function hud(){
  const score = moneyScore();
  document.getElementById("kRound").textContent = `${state.round}/${TOTAL_ROUNDS}`;
  document.getElementById("kLevel").textContent = `${levelName()} (Lv ${state.level+1})`;
  document.getElementById("kCash").textContent = fmt(state.cash);
  document.getElementById("kSave").textContent = fmt(state.savings);
  document.getElementById("kInv").textContent = fmt(state.invest);
  document.getElementById("kDebtScore").innerHTML =
    `<span class="${state.debt>0 ? "bad":"muted"}">${fmt(state.debt)}</span>
     <span class="muted"> / </span>
     <span class="${score>=0 ? "good":"bad"}">${fmt(score)}</span>`;

  document.getElementById("pillStreak").textContent = `Streak: ${state.streak}`;
  document.getElementById("pillGoal").textContent = `Goal: ${TOTAL_ROUNDS} rounds`;

  const pct = Math.round((state.round-1) / TOTAL_ROUNDS * 100);
  document.getElementById("progressBar").style.width = `${pct}%`;
}

function newGame(){
  const name = document.getElementById("playerName").value.trim() || "Player 1";
  state = {
    version: 1,
    name,
    rngSeedText: document.getElementById("seed").value.trim(),
    round: 1,
    level: 0,      // index into LEVELS (0..4)
    streak: 0,

    cash: 100,
    savings: 0,
    invest: 0,
    debt: 0,

    log: []
  };
  ui.phase = "start";
  ui.draft = null;

  log(`New game started for ${name}.`);
  log("You start with $100 cash.");
  setTip(microTips[0]);
  hud();
  render();
}

function saveGame(){
  if(!state) return;
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ state, ui }));
  log("Saved game to this browser.");
}

function loadGame(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert("No saved game found in this browser."); return; }
  try{
    const parsed = JSON.parse(raw);
    state = parsed.state;
    ui = parsed.ui || ui;
    log("\nLoaded saved game.");
    hud();
    render();
  }catch(e){
    alert("Could not load saved game.");
  }
}

function resetGame(){
  if(!confirm("Reset the game?")) return;
  state = null;
  ui = { phase: "start", draft: null };
  document.getElementById("log").textContent = "";
  newGame();
}

/* ---------- Skill effects (simple and small) ---------- */
function softenBadCost(amount){
  // amount is negative cost (e.g., -60). Higher level reduces the hit a bit.
  const lvl = state.level;
  const reduce = 0.04 * lvl; // up to 16%
  return Math.round(amount * (1 - reduce));
}

function improveInvestPct(pct){
  // Improve investment result a bit as level rises
  const lvl = state.level;
  const bump = 0.01 * lvl; // up to +4%
  return pct + bump;
}

function plannerCushion(){
  // Small bonus each round for Planner+
  if(state.level >= 2) return 10; // +$10
  return 0;
}

/* ---------- Round mechanics ---------- */
function startRound(){
  const rng = getRng();
  // Keep RNG stable if seed exists; we also incorporate round so each round changes.
  // If user uses a seed, we derive a new rng for each round deterministically.
  const seedText = document.getElementById("seed").value.trim();
  let localRng = rng;
  if(seedText){
    const base = Number(seedText);
    if(Number.isFinite(base)){
      localRng = mulberry32((base + state.round * 101) >>> 0);
    }
  }

  // Draft round info
  const job = paychecks[rint(localRng, 0, paychecks.length - 1)];
  const pay = rint(localRng, job.min, job.max);

  const mustPay = rint(localRng, MUST_PAY_MIN, MUST_PAY_MAX);

  ui.draft = {
    rng: localRng,
    jobName: job.name,
    paycheck: pay,
    mustPay: mustPay,
    afterMust: 0,

    // plan outcome (set later)
    planName: "",
    spend: 0,
    save: 0,
    invest: 0,

    // surprise
    surprise: null,
    surpriseText: "",
    choiceResult: null, // for choice surprises

    // results
    saveBefore: 0,
    saveAfter: 0,
    invBefore: 0,
    invAfter: 0,
    invPct: 0
  };

  ui.phase = "paid";
  render();
}

function applyPlan(planKey){
  const d = ui.draft;
  if(!d) return;

  // Collect paycheck and add any planner cushion
  const cushion = plannerCushion();
  state.cash += d.paycheck + cushion;

  // Must-pays come out of cash; if not enough, debt fills the gap.
  const cost = d.mustPay;
  if(state.cash >= cost){
    state.cash -= cost;
  }else{
    const gap = cost - state.cash;
    state.cash = 0;
    state.debt += gap;
  }

  // After must-pays, figure how much cash we have right now for the plan
  const available = state.cash;

  // Plans are percentages of "available"
  // Safe: 50% save, 20% invest, 30% spend
  // Balanced: 35% save, 35% invest, 30% spend
  // Bold: 20% save, 55% invest, 25% spend
  let saveP=0.50, invP=0.20, spendP=0.30;
  if(planKey === "balanced"){ saveP=0.35; invP=0.35; spendP=0.30; }
  if(planKey === "bold"){ saveP=0.20; invP=0.55; spendP=0.25; }

  const save = Math.round(available * saveP);
  const inv  = Math.round(available * invP);
  const spend= Math.max(0, available - save - inv);

  // Move money
  state.cash -= (save + inv + spend);
  state.savings += save;
  state.invest += inv;

  d.planName = (planKey === "safe" ? "Safe" : planKey === "balanced" ? "Balanced" : "Bold");
  d.save = save; d.invest = inv; d.spend = spend;

  // A tiny teaching reinforcement:
  // if they chose Safe/Balanced/Bold, we adapt tips later.

  ui.phase = "surprise";
  render();
}

function applyGrowth(){
  const d = ui.draft;
  if(!d) return;

  // Savings grows slowly
  d.saveBefore = state.savings;
  state.savings = Math.round(state.savings * (1 + SAVINGS_GROWTH));
  d.saveAfter = state.savings;

  // Investments change randomly
  const pct = rfloat(d.rng, INV_MIN, INV_MAX);
  const pct2 = improveInvestPct(pct);
  d.invPct = pct2;

  d.invBefore = state.invest;
  state.invest = Math.round(state.invest * (1 + pct2));
  d.invAfter = state.invest;

  // Debt interest
  if(state.debt > 0){
    state.debt = Math.round(state.debt * (1 + DEBT_INTEREST));
  }
}

function drawSurprise(){
  const d = ui.draft;
  if(!d) return;

  const s = surprises[rint(d.rng, 0, surprises.length - 1)];
  d.surprise = s;

  if(s.kind === "cash"){
    let impact = rint(d.rng, s.min, s.max); // negative or positive
    if(impact < 0) impact = softenBadCost(impact);
    d.surpriseText = (impact >= 0) ? `You got ${fmt(impact)}.` : `You owe ${fmt(-impact)}.`;

    // Apply to cash; if not enough cash for a cost, create debt
    if(impact >= 0){
      state.cash += impact;
    }else{
      const cost = -impact;
      if(state.cash >= cost){
        state.cash -= cost;
      }else{
        const gap = cost - state.cash;
        state.cash = 0;
        state.debt += gap;
      }
    }
  }

  if(s.kind === "market"){
    // apply to investments
    let pct = rfloat(d.rng, s.min, s.max);
    pct = improveInvestPct(pct);
    d.surpriseText = `Your invest money changed by ${(pct*100).toFixed(1)}%.`;
    state.invest = Math.round(state.invest * (1 + pct));
  }

  if(s.kind === "choice"){
    // Offer a quick yes/no choice
    d.surpriseText = `Do you go out for ${fmt(s.cost)}?`;
  }

  // Apply growth at the end (after surprise choice resolves if needed)
}

function resolveChoiceSurprise(choice){
  const d = ui.draft;
  const s = d.surprise;
  if(!s || s.kind !== "choice") return;

  const cost = s.cost;

  if(choice === "go"){
    if(state.cash >= cost){
      state.cash -= cost;
      d.choiceResult = `You went out. (-${fmt(cost)})`;
    }else{
      const gap = cost - state.cash;
      state.cash = 0;
      state.debt += gap;
      d.choiceResult = `You went out, but you didn‚Äôt have enough cash. Debt +${fmt(gap)}.`;
    }
  }else{
    d.choiceResult = "You stayed in. ($0)";
  }
}

function finishRound(){
  const d = ui.draft;
  if(!d) return;

  // If surprise was not choice-based, it already applied.
  // For choice surprise, ensure choice was made:
  if(d.surprise && d.surprise.kind === "choice" && d.choiceResult == null){
    alert("Pick Go Out or Stay In first.");
    return;
  }

  // Growth happens at end of round (so player sees cause ‚Üí effect)
  applyGrowth();

  const scoreNow = moneyScore();

  // streak logic (simple)
  // Increase streak if: no new debt AND savings went up OR score improved.
  // Because we don't store prev score in state, compute a simple ‚Äúgood round‚Äù check:
  const goodRound = (state.debt === 0) || (d.planName !== "Bold" && state.debt < 200);
  if(goodRound){
    state.streak += 1;
  }else{
    state.streak = 0;
  }

  // log
  log(`\nROUND ${state.round}/${TOTAL_ROUNDS}`);
  log(`Paid: ${d.jobName} (+${fmt(d.paycheck)})${plannerCushion() ? ` + Planner cushion (+${fmt(plannerCushion())})` : ""}`);
  log(`Must-pays: -${fmt(d.mustPay)} (some money gets taken out automatically)`);
  log(`Plan: ${d.planName} | Save ${fmt(d.save)} | Invest ${fmt(d.invest)} | Spend ${fmt(d.spend)}`);

  if(d.surprise){
    log(`Surprise: ${d.surprise.name} ‚Äî ${d.surpriseText}`);
    if(d.choiceResult) log(`Choice: ${d.choiceResult}`);
  }

  log(`Savings grew: ${fmt(d.saveBefore)} ‚Üí ${fmt(d.saveAfter)} (+${fmt(d.saveAfter - d.saveBefore)})`);
  const invDelta = d.invAfter - d.invBefore;
  log(`Invest changed: ${(d.invPct*100).toFixed(1)}% | ${fmt(d.invBefore)} ‚Üí ${fmt(d.invAfter)} (${invDelta>=0?"+":""}${fmt(invDelta)})`);
  if(state.debt > 0) log(`Debt now: ${fmt(state.debt)} (debt grows when you owe money)`);

  log(`Money Score: ${fmt(scoreNow)} | Streak: ${state.streak}`);

  // tip update
  const tip = d.surprise?.tip || microTips[rint(d.rng, 0, microTips.length - 1)];
  setTip(tip);

  // advance
  state.round += 1;
  ui.draft = null;

  if(state.round > TOTAL_ROUNDS){
    ui.phase = "end";
  }else{
    ui.phase = "start";
  }

  hud();
  render();
}

/* ---------- UI Render ---------- */
function render(){
  const card = document.getElementById("gameCard");
  if(!state){
    card.innerHTML = `<div class="bigTitle">Loading‚Ä¶</div>`;
    return;
  }

  // Disable skill button if max
  const skillBtn = document.getElementById("btnSkill");
  skillBtn.disabled = (state.level >= LEVELS.length - 1);

  if(ui.phase === "end"){
    const score = moneyScore();
    const cls = score >= 0 ? "good" : "bad";
    card.innerHTML = `
      <div class="bigTitle">Game complete. üéâ</div>
      <div class="bigBody">
        <strong>${state.name}</strong>, you finished ${TOTAL_ROUNDS} rounds.<br/>
        Your Money Score: <strong class="${cls}">${fmt(score)}</strong><br/><br/>
        <span class="small">
          What you practiced: paying must-pays first, saving a little, investing with ups/downs, and avoiding debt.
        </span>
      </div>
      <div class="btnRow">
        <button class="danger half" id="playAgain">Play again</button>
        <button class="secondary half" id="saveEnd">Save this run</button>
      </div>
    `;
    document.getElementById("playAgain").onclick = () => resetGame();
    document.getElementById("saveEnd").onclick = () => saveGame();
    return;
  }

  if(ui.phase === "start"){
    card.innerHTML = `
      <div class="bigTitle">Ready for the next money moment?</div>
      <div class="bigBody">
        Round <strong>${state.round}</strong> of <strong>${TOTAL_ROUNDS}</strong>.<br/>
        Tap <strong>Start Round</strong>. You‚Äôll get paid, pay must-pays, pick a plan, then handle a surprise.
      </div>
      <div class="choiceGrid" style="grid-template-columns:1fr;">
        <button id="startBtn"><div style="font-size:15px;">Start Round</div><div class="small">Fast. Simple. Tap choices.</div></button>
      </div>
    `;
    document.getElementById("startBtn").onclick = () => startRound();
    return;
  }

  if(ui.phase === "paid"){
    const d = ui.draft;
    const after = Math.max(0, state.cash + d.paycheck + plannerCushion() - d.mustPay); // preview
    card.innerHTML = `
      <div class="bigTitle">You got paid</div>
      <div class="bigBody">
        Job: <strong>${d.jobName}</strong><br/>
        Paycheck: <strong>${fmt(d.paycheck)}</strong>
        ${plannerCushion() ? `<br/>Bonus (skill perk): <strong>+${fmt(plannerCushion())}</strong>` : ""}
      </div>

      <div class="hr"></div>

      <div class="bigTitle">Must-pays</div>
      <div class="bigBody">
        Must-pays today: <strong>${fmt(d.mustPay)}</strong><br/>
        (This is ‚Äústuff you have to pay for,‚Äù plus money taken out automatically.)
      </div>

      <div class="tip">Preview: after must-pays, you‚Äôll have about <strong>${fmt(after)}</strong> to decide what to do next.</div>

      <div class="btnRow">
        <button class="half" id="goPlan">Continue</button>
      </div>
    `;
    document.getElementById("goPlan").onclick = () => { ui.phase = "plan"; render(); };
    return;
  }

  if(ui.phase === "plan"){
    const d = ui.draft;
    const availablePreview = Math.max(0, state.cash + d.paycheck + plannerCushion() - d.mustPay);
    card.innerHTML = `
      <div class="bigTitle">Pick a plan</div>
      <div class="bigBody">
        You‚Äôll have about <strong>${fmt(availablePreview)}</strong> left after must-pays.<br/>
        Choose one plan. (No math. Just tap.)
      </div>

      <div class="choiceGrid">
        <button id="planSafe">
          <div style="font-size:14px;">SAFE</div>
          <div class="small">Save a lot. Invest a little. Spend a little.</div>
        </button>

        <button id="planBalanced">
          <div style="font-size:14px;">BALANCED</div>
          <div class="small">Save some. Invest some. Spend some.</div>
        </button>

        <button id="planBold">
          <div style="font-size:14px;">BOLD</div>
          <div class="small">Invest a lot. Save a little. Spend a little.</div>
        </button>
      </div>

      <div class="tip">Quick rule: If you always save at least a little, surprises hurt less.</div>
    `;

    document.getElementById("planSafe").onclick = () => {
      applyPlan("safe");
      drawSurprise();
      render();
    };
    document.getElementById("planBalanced").onclick = () => {
      applyPlan("balanced");
      drawSurprise();
      render();
    };
    document.getElementById("planBold").onclick = () => {
      applyPlan("bold");
      drawSurprise();
      render();
    };
    return;
  }

  if(ui.phase === "surprise"){
    const d = ui.draft;
    const s = d.surprise;
    const isChoice = s && s.kind === "choice";
    card.innerHTML = `
      <div class="bigTitle">Surprise card</div>
      <div class="bigBody">
        <strong>${s ? s.name : "‚Äî"}</strong><br/>
        ${d.surpriseText || ""}
      </div>

      ${isChoice ? `
        <div class="choiceGrid" style="margin-top:14px;">
          <button id="goOut"><div style="font-size:14px;">Go out</div><div class="small">Costs ${fmt(s.cost)}</div></button>
          <button id="stayIn" class="secondary"><div style="font-size:14px;">Stay in</div><div class="small">Costs $0</div></button>
          <button id="skip" class="secondary" disabled><div style="font-size:14px;">(Pick one)</div><div class="small">Then finish the round.</div></button>
        </div>
      ` : `
        <div class="tip">Now we‚Äôll see what grew (and what didn‚Äôt).</div>
      `}

      <div class="btnRow">
        <button class="half" id="finishBtn">Finish Round</button>
      </div>
    `;

    if(isChoice){
      document.getElementById("goOut").onclick = () => { resolveChoiceSurprise("go"); render(); };
      document.getElementById("stayIn").onclick = () => { resolveChoiceSurprise("stay"); render(); };
    }

    document.getElementById("finishBtn").onclick = () => {
      finishRound();
    };
    return;
  }
}

/* ---------- Skill button ---------- */
function levelUp(){
  if(state.level >= LEVELS.length - 1) return;

  const next = state.level + 1;
  const cost = LEVELS[next].cost;

  if(state.cash < cost){
    alert(`You need ${fmt(cost)} cash to level up.`);
    return;
  }

  state.cash -= cost;
  state.level = next;

  log(`Leveled up to ${LEVELS[state.level].name}. (-${fmt(cost)})`);
  log(`Perk: ${LEVELS[state.level].perk}`);

  setTip(LEVELS[state.level].perk);
  hud();
  render();
}

/* ---------- Wire buttons ---------- */
document.getElementById("btnSkill").onclick = levelUp;
document.getElementById("btnSave").onclick = saveGame;
document.getElementById("btnLoad").onclick = loadGame;
document.getElementById("btnReset").onclick = resetGame;

/* ---------- Boot ---------- */
newGame();
</script>
</body>
</html>
