<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Money Lab — Tap Card Game</title>
  <style>
    :root{
      --bg:#070a16;
      --text:#eef1ff;
      --muted:#aab3da;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --good:#5ee6a8;
      --bad:#ff6b7a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, var(--bg) 55%);
      color:var(--text);
      overflow-x:hidden;
    }
    header{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(7,10,22,.75);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
    }
    header .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width: 1100px; margin:0 auto;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    .brandDot{
      width:12px; height:12px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,.12);
      border:1px solid rgba(255,255,255,.12);
    }
    .sub{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35; }
    main{ max-width:1100px; margin:0 auto; padding: 16px; }

    .hud{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-bottom: 14px;
    }
    @media (max-width: 980px){
      .hud{ grid-template-columns: repeat(3, 1fr); }
    }
    .kpi{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 62px;
    }
    .kpi .t{ font-size:11px; color:var(--muted); }
    .kpi .v{ margin-top:6px; font-weight:900; letter-spacing:.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
      min-height: 440px;
    }
    .side{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card{
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      padding: 14px;
    }
    .bigTitle{ font-size: 20px; font-weight: 950; margin: 0 0 6px; }
    .bigBody{ color: var(--muted); line-height: 1.45; }

    button{
      border-radius: 16px;
      border:1px solid rgba(122,162,255,.65);
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      color: var(--text);
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      width:100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-align:left;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight: 800;
    }
    button.danger{
      border-color: rgba(255,107,122,.65);
      background: linear-gradient(180deg, rgba(255,107,122,.95), rgba(255,107,122,.70));
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btnRow .half{ flex:1 1 220px; }
    .btnRow .third{ flex:1 1 160px; }

    input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }

    .choiceGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (min-width: 860px){
      .choiceGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .tip{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      font-size: 12px;
      font-weight: 900;
      margin-right: 8px;
      margin-bottom: 8px;
      flex-wrap:wrap;
    }
    .avatarDot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05);
    }

    .progressWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
      height: 10px;
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(94,230,168,.95), rgba(122,162,255,.95));
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      max-height: 360px;
      overflow:auto;
    }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    /* Screens */
    .screen{
      position:absolute;
      inset:0;
      padding: 14px;
      transform: translateX(110%);
      opacity: 0;
      transition: transform .35s ease, opacity .35s ease;
    }
    .screen.active{
      transform: translateX(0%);
      opacity: 1;
    }
    .screen.left{
      transform: translateX(-110%);
      opacity: 0;
    }

    ul.clean{ margin:10px 0 0 18px; color:var(--muted); }
    .billList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .billItem{
      display:flex; justify-content:space-between; gap:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .billItem strong{ color: var(--text); }

    .palette{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .colorPick{
      width:34px; height:34px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.20);
      position:relative;
    }
    .colorPick.selected::after{
      content:"";
      position:absolute; inset:7px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 0 3px rgba(255,255,255,.10);
    }

    /* Header mini controls */
    .headerControls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini{
      display:flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .toggle{
      width: 44px; height: 24px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .toggleKnob{
      position:absolute; top:3px; left:3px;
      width:18px; height:18px; border-radius:999px;
      background: rgba(255,255,255,.85);
      transition: left .15s ease, background .15s ease;
    }
    .toggle.on{
      background: rgba(94,230,168,.18);
      border-color: rgba(94,230,168,.35);
    }
    .toggle.on .toggleKnob{ left:23px; background: rgba(94,230,168,.95); }

    /* Confetti canvas */
    #confetti{
      position: fixed;
      inset:0;
      pointer-events:none;
      z-index:999;
    }
  </style>
</head>

<body>
<canvas id="confetti"></canvas>

<header>
  <div class="top">
    <div>
      <h1>
        <span class="brandDot" id="brandDot"></span>
        Money Lab — Tap Card Game
      </h1>
      <div class="sub">Fast rounds. Tap choices. Learn by doing.</div>
    </div>

    <div class="headerControls">
      <div class="mini">
        Sound
        <div class="toggle" id="soundToggle" role="switch" aria-checked="false" tabindex="0">
          <div class="toggleKnob"></div>
        </div>
      </div>

      <div class="mini" style="gap:10px;">
        <div>Seed</div>
        <input id="seed" type="text" placeholder="e.g., 2026"
               style="width:160px; max-width:38vw; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18); color:var(--text); outline:none;" />
      </div>
    </div>
  </div>
</header>

<main>
  <section class="hud" aria-label="HUD">
    <div class="kpi"><div class="t">Round</div><div class="v" id="kRound">—</div></div>
    <div class="kpi"><div class="t">Level</div><div class="v" id="kLevel">—</div></div>
    <div class="kpi"><div class="t">Cash</div><div class="v" id="kCash">—</div></div>
    <div class="kpi"><div class="t">Savings</div><div class="v" id="kSave">—</div></div>
    <div class="kpi"><div class="t">Invest</div><div class="v" id="kInv">—</div></div>
    <div class="kpi"><div class="t">Debt / Score</div><div class="v" id="kDebtScore">—</div></div>
  </section>

  <div class="grid">
    <!-- MAIN (MULTI-SCREEN) -->
    <section class="panel" aria-label="App screens">
      <div class="screen" id="screen-intro">
        <div class="card">
          <div class="bigTitle">Welcome to Money Lab</div>
          <div class="bigBody">
            Quick money game. You’ll practice:
            <strong>pay bills</strong>, <strong>save</strong>, and <strong>invest</strong> — without boring math.
          </div>
          <div class="btnRow">
            <button class="half" id="btnIntroNext">Enter</button>
            <button class="secondary half" id="btnIntroHow">How to play</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-how">
        <div class="card">
          <div class="bigTitle">How to play (3 steps)</div>
          <ul class="clean">
            <li>You get paid.</li>
            <li>You pay bills.</li>
            <li>You tap a plan (Safe / Balanced / Bold), then handle a surprise.</li>
          </ul>
          <div class="tip">Tip: Saving a little first makes surprises hurt less.</div>
          <div class="btnRow">
            <button class="secondary half" id="btnHowBack">Back</button>
            <button class="half" id="btnHowNext">Continue</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-setup">
        <div class="card">
          <div class="bigTitle">Pick your player</div>
          <div class="bigBody">Choose a name and a color. Then tap Start.</div>

          <div style="margin-top:10px;">
            <div class="sub">Name</div>
            <input id="playerName" type="text" value="Player 1" />
          </div>

          <div style="margin-top:10px;">
            <div class="sub">Avatar color</div>
            <div class="palette" id="palette"></div>
            <div class="tip">This color follows you in the app (and makes it feel more like a real game).</div>
          </div>

          <div class="btnRow">
            <button class="secondary half" id="btnSetupBack">Back</button>
            <button class="half" id="btnSetupStart">Start Game</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-startRound">
        <div class="card">
          <div class="bigTitle">Ready?</div>
          <div class="bigBody">Tap Start Round. You’ll get paid, pay bills, and make a quick choice.</div>
          <div class="btnRow">
            <button class="half" id="btnStartRound">Start Round</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-paidBills">
        <div class="card">
          <div class="bigTitle">You got paid</div>
          <div class="bigBody" id="paidText">—</div>

          <div class="hr"></div>

          <div class="bigTitle">Bills</div>
          <div class="bigBody">Here’s what you have to pay today:</div>
          <div class="billList" id="billList"></div>
          <div class="tip" id="billTotalTip">Total bills: —</div>

          <div class="btnRow">
            <button class="half" id="btnPaidContinue">Continue</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-plan">
        <div class="card">
          <div class="bigTitle">Pick a plan</div>
          <div class="bigBody" id="planPreview">—</div>

          <div class="choiceGrid">
            <button id="planSafe">
              <div>SAFE</div>
              <div class="sub">Save a lot. Invest a little. Spend a little.</div>
            </button>
            <button id="planBalanced">
              <div>BALANCED</div>
              <div class="sub">Save some. Invest some. Spend some.</div>
            </button>
            <button id="planBold">
              <div>BOLD</div>
              <div class="sub">Invest a lot. Save a little. Spend a little.</div>
            </button>
          </div>

          <div class="tip">Auto-advance: after you tap a plan, you’ll go straight to the surprise card.</div>
        </div>
      </div>

      <div class="screen" id="screen-surprise">
        <div class="card">
          <div class="bigTitle">Surprise card</div>
          <div class="bigBody" id="surpriseText">—</div>

          <div class="choiceGrid" id="surpriseChoices" style="display:none;">
            <button id="btnGoOut"><div>Go out</div><div class="sub" id="goOutCost">Costs —</div></button>
            <button id="btnStayIn" class="secondary"><div>Stay in</div><div class="sub">Costs $0</div></button>
            <button class="secondary" disabled><div>Pick one</div><div class="sub">Then we move on.</div></button>
          </div>

          <div class="tip" id="surpriseTip">After this, we show your results.</div>
        </div>
      </div>

      <div class="screen" id="screen-result">
        <div class="card">
          <div class="bigTitle">Round results</div>
          <div class="bigBody" id="resultText">—</div>
          <div class="tip" id="resultTip">—</div>
          <div class="btnRow">
            <button class="half" id="btnNextRound">Next Round</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-finish">
        <div class="card">
          <div class="bigTitle">Game complete</div>
          <div class="bigBody" id="finishText">—</div>
          <div class="btnRow">
            <button class="danger half" id="btnPlayAgain">Play again</button>
            <button class="secondary half" id="btnSaveRun">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <section class="side" aria-label="Progress + Ledger">
      <div class="card">
        <div class="pill" id="pillPlayer">
          <span class="avatarDot" id="avatarDot"></span>
          <span id="playerLabel">Player</span>
        </div>
        <div class="pill" id="pillStreak">Streak: 0</div>
        <div class="pill" id="pillGoal">Goal: —</div>

        <div class="progressWrap" aria-label="Progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="tip" id="tipBox">Tip: Save a little first. Future you will be grateful.</div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <div class="bigTitle" style="font-size:16px;">Ledger</div>
        <div id="log" class="log"></div>
      </div>

      <div class="btnRow">
        <button class="secondary third" id="btnSkill">Level up money skills</button>
        <button class="secondary third" id="btnSave">Save</button>
        <button class="secondary third" id="btnLoad">Load</button>
        <button class="danger third" id="btnReset">Reset</button>
      </div>
    </section>
  </div>
</main>

<script>
/* =========================================================
   MONEY LAB — Multi-screen + Avatar + Goals + Confetti + Sound
   Single-file app for GitHub Pages
========================================================= */

/* ====== SETTINGS ====== */
const TOTAL_ROUNDS = 20;

const AVATAR_COLORS = [
  "#7aa2ff", "#5ee6a8", "#ff6b7a", "#ffd36a", "#b48cff", "#58e1ff"
];

const BILLS_DECK = [
  { name: "Phone bill", min: 10, max: 35 },
  { name: "Transportation", min: 8, max: 30 },
  { name: "Lunch/snacks", min: 5, max: 22 },
  { name: "Subscription", min: 5, max: 15 },
  { name: "Supplies", min: 8, max: 25 },
  { name: "Family errand", min: 6, max: 20 }
];

const SAVINGS_GROWTH = 0.01;
const INV_MIN = -0.06;
const INV_MAX =  0.12;
const DEBT_INTEREST = 0.03;

const LEVELS = [
  { name: "Rookie",    perk: "No perk yet. You’re learning.",               cost: 0 },
  { name: "Saver",     perk: "Bad surprises cost a little less.",          cost: 250 },
  { name: "Planner",   perk: "You get a small bonus each round.",          cost: 350 },
  { name: "Investor",  perk: "Your invest results are slightly better.",   cost: 450 },
  { name: "Boss",      perk: "You lose less on bad luck days.",            cost: 600 }
];

const PAYCHECKS = [
  { name: "Babysitting", min: 60, max: 140 },
  { name: "Part-time shift", min: 90, max: 180 },
  { name: "Gig job", min: 50, max: 220 },
  { name: "Small hustle", min: 40, max: 260 },
  { name: "Weekend work", min: 80, max: 210 }
];

const SURPRISES = [
  { name: "Phone screen cracked", kind:"cash", min:-70, max:-30, tip:"Stuff breaks. Savings helps." },
  { name: "Friend invites you out", kind:"choice", cost:25, tip:"Fun is fine — plan for it." },
  { name: "Lost something (replace it)", kind:"cash", min:-45, max:-15, tip:"Small leaks add up." },
  { name: "You got a small bonus", kind:"cash", min:25, max:80, tip:"Don’t blow wins — build wins." },
  { name: "Market dip", kind:"market", min:-0.08, max:-0.03, tip:"Investing goes down sometimes. That’s normal." },
  { name: "Market pop", kind:"market", min:0.03, max:0.10, tip:"Good days happen. Don’t get reckless." },
  { name: "Someone pays you back", kind:"cash", min:20, max:65, tip:"When money returns, save some." },
  { name: "Emergency bill", kind:"cash", min:-60, max:-20, tip:"Unexpected bills are real. Buffer matters." }
];

const MICRO_TIPS = [
  "Save a little first. Future you will be grateful.",
  "Debt grows if you ignore it.",
  "Investing can go up or down. That’s normal.",
  "A plan beats vibes every time.",
  "Cash is for now. Savings is for later.",
  "If you have no buffer, one surprise can wreck you."
];

// Simple “Goal Cards”
const GOALS = [
  {
    id: "save250",
    label: "Save $250 by Round 8",
    description: "Build a safety cushion early.",
    check: (state) => state.round >= 8 && state.savings >= 250
  },
  {
    id: "noDebt10",
    label: "No debt by Round 10",
    description: "Avoid owing money.",
    check: (state) => state.round >= 10 && state.debt === 0
  },
  {
    id: "invest200",
    label: "Invest $200 by Round 8",
    description: "Start growing money early.",
    check: (state) => state.round >= 8 && state.invest >= 200
  }
];

const STORAGE_KEY = "moneyLabMultiScreen_v2";

/* ====== UTILS ====== */
const fmt = (n) => {
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 0 });
};

function mulberry32(a){
  return function(){
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function getRoundRng(round){
  const s = document.getElementById("seed").value.trim();
  if(!s) return Math.random;
  const n = Number(s);
  if(!Number.isFinite(n)) return Math.random;
  return mulberry32((n + round * 101) >>> 0);
}
function rint(rng, min, max){
  return Math.floor(rng() * (max - min + 1)) + min;
}
function rfloat(rng, min, max){
  return rng() * (max - min) + min;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* ====== SOUND (simple beeps, no external files) ====== */
let soundOn = false;
let audioCtx = null;

function ensureAudio(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
  }
}
function beep(freq=520, duration=0.06, type="sine", gain=0.05){
  if(!soundOn) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(gain, t0);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
  osc.connect(g).connect(audioCtx.destination);
  osc.start(t0);
  osc.stop(t0 + duration);
}
function sfxTap(){ beep(520, 0.05, "triangle", 0.04); }
function sfxWin(){ beep(740, 0.06, "sine", 0.05); setTimeout(()=>beep(980,0.07,"sine",0.05), 80); }
function sfxLose(){ beep(240, 0.07, "sine", 0.05); setTimeout(()=>beep(190,0.08,"sine",0.05), 90); }

/* ====== CONFETTI ====== */
const confettiCanvas = document.getElementById("confetti");
const conf = confettiCanvas.getContext("2d");
let confettiParticles = [];

function resizeConfetti(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function launchConfetti(intensity=120){
  // Create simple rectangle particles
  const w = confettiCanvas.width, h = confettiCanvas.height;
  for(let i=0; i<intensity; i++){
    confettiParticles.push({
      x: Math.random() * w,
      y: -20 - Math.random() * h * 0.25,
      vx: (Math.random()-0.5) * 2.2,
      vy: 2.0 + Math.random() * 3.5,
      r: Math.random() * Math.PI,
      vr: (Math.random()-0.5) * 0.2,
      size: 5 + Math.random()*6,
      life: 220 + Math.random()*120,
      color: AVATAR_COLORS[Math.floor(Math.random()*AVATAR_COLORS.length)]
    });
  }
}
function stepConfetti(){
  const w = confettiCanvas.width, h = confettiCanvas.height;
  conf.clearRect(0,0,w,h);

  confettiParticles = confettiParticles.filter(p => p.life > 0);
  for(const p of confettiParticles){
    p.life -= 1;
    p.x += p.vx;
    p.y += p.vy;
    p.r += p.vr;
    p.vy += 0.01; // tiny gravity
    if(p.y > h + 30) p.life = 0;

    conf.save();
    conf.translate(p.x, p.y);
    conf.rotate(p.r);
    conf.fillStyle = p.color;
    conf.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.7);
    conf.restore();
  }
  requestAnimationFrame(stepConfetti);
}
stepConfetti();

/* ====== STATE ====== */
let state = null;
let draft = null;

/* ====== UI HELPERS ====== */
function levelName(){ return LEVELS[clamp(state.level,0,LEVELS.length-1)].name; }
function moneyScore(){
  return Math.round((state.cash + state.savings + state.invest) - (state.debt * 1.2) + (state.streak * 10));
}
function log(line){
  state.log.push(line);
  const el = document.getElementById("log");
  el.textContent = state.log.join("\n");
  el.scrollTop = el.scrollHeight;
}
function setTip(text){
  document.getElementById("tipBox").textContent = "Tip: " + text;
}
function hud(){
  const score = moneyScore();
  document.getElementById("kRound").textContent = `${state.round}/${TOTAL_ROUNDS}`;
  document.getElementById("kLevel").textContent = `${levelName()} (Lv ${state.level+1})`;
  document.getElementById("kCash").textContent = fmt(state.cash);
  document.getElementById("kSave").textContent = fmt(state.savings);
  document.getElementById("kInv").textContent = fmt(state.invest);

  document.getElementById("kDebtScore").innerHTML =
    `<span class="${state.debt>0 ? "bad":"sub"}">${fmt(state.debt)}</span>
     <span class="sub"> / </span>
     <span class="${score>=0 ? "good":"bad"}">${fmt(score)}</span>`;

  document.getElementById("pillStreak").textContent = `Streak: ${state.streak}`;

  // Goal pill
  const g = GOALS.find(x => x.id === state.goalId);
  const goalText = g ? g.label : "Goal: —";
  document.getElementById("pillGoal").textContent = `Goal: ${goalText}`;

  // Player pill + avatar dot
  document.getElementById("playerLabel").textContent = state.name;
  document.getElementById("avatarDot").style.background = state.avatarColor;
  document.getElementById("brandDot").style.background = state.avatarColor;

  const pct = Math.round((state.round-1) / TOTAL_ROUNDS * 100);
  document.getElementById("progressBar").style.width = `${pct}%`;
}

/* ====== SCREEN NAV ====== */
let currentScreenId = "screen-intro";
function go(screenId){
  const current = document.getElementById(currentScreenId);
  const next = document.getElementById(screenId);
  if(!current || !next) return;

  current.classList.remove("active");
  current.classList.add("left");

  document.querySelectorAll(".screen").forEach(s => {
    if(s.id !== screenId && s.id !== currentScreenId){
      s.classList.remove("active");
      s.classList.remove("left");
    }
  });

  next.classList.add("active");
  next.classList.remove("left");

  setTimeout(() => current.classList.remove("left"), 360);

  currentScreenId = screenId;
}

/* ====== GAME MECHANICS ====== */
function plannerBonus(){ return (state.level >= 2) ? 10 : 0; }
function softenBadCost(amount){
  const reduce = 0.04 * state.level;
  return Math.round(amount * (1 - reduce));
}
function improveInvestPct(pct){ return pct + 0.01 * state.level; }

function buildBills(rng){
  const nBills = rint(rng, 2, 4);
  const picked = [];
  const used = new Set();
  while(picked.length < nBills){
    const b = BILLS_DECK[rint(rng, 0, BILLS_DECK.length - 1)];
    if(used.has(b.name)) continue;
    used.add(b.name);
    picked.push({ name: b.name, amount: rint(rng, b.min, b.max) });
  }
  const total = picked.reduce((s,x) => s + x.amount, 0);
  return { items: picked, total };
}

/* ====== GOALS ====== */
function pickGoal(rng){
  const g = GOALS[rint(rng, 0, GOALS.length - 1)];
  return g.id;
}
function checkGoalCompletion(){
  if(state.goalCompleted) return false;
  const g = GOALS.find(x => x.id === state.goalId);
  if(!g) return false;
  if(g.check(state)){
    state.goalCompleted = true;
    return true;
  }
  return false;
}

/* ====== NEW GAME ====== */
function newGame(){
  state = {
    name: "Player 1",
    avatarColor: AVATAR_COLORS[0],
    round: 1,
    level: 0,
    streak: 0,
    cash: 100,
    savings: 0,
    invest: 0,
    debt: 0,
    log: [],

    goalId: null,
    goalCompleted: false
  };
  draft = null;

  const rng = getRoundRng(1);
  state.goalId = pickGoal(rng);

  setTip(MICRO_TIPS[0]);
  log("New game started. You start with $100 cash.");
  const g = GOALS.find(x => x.id === state.goalId);
  if(g){
    log(`Goal card: ${g.label}`);
    log(`Goal hint: ${g.description}`);
  }

  hud();
  go("screen-intro");
}

/* ====== ROUND FLOW ====== */
function startRound(){
  const rng = getRoundRng(state.round);

  const job = PAYCHECKS[rint(rng, 0, PAYCHECKS.length - 1)];
  const paycheck = rint(rng, job.min, job.max);
  const bills = buildBills(rng);

  draft = {
    rng,
    jobName: job.name,
    paycheck,
    billsItems: bills.items,
    billsTotal: bills.total,

    planName: "",
    save: 0, invest: 0, spend: 0,

    surprise: null,
    surpriseText: "",
    choiceResult: null,

    beforeScore: moneyScore(),
    afterScore: null,
    saveBefore: null, saveAfter: null,
    invBefore: null, invAfter: null,
    invPct: 0
  };

  document.getElementById("paidText").innerHTML =
    `Job: <strong>${draft.jobName}</strong><br/>Paycheck: <strong>${fmt(draft.paycheck)}</strong>` +
    (plannerBonus() ? `<br/>Bonus (perk): <strong>+${fmt(plannerBonus())}</strong>` : "");

  const list = document.getElementById("billList");
  list.innerHTML = "";
  draft.billsItems.forEach(b => {
    const div = document.createElement("div");
    div.className = "billItem";
    div.innerHTML = `<span>${b.name}</span><strong>${fmt(b.amount)}</strong>`;
    list.appendChild(div);
  });
  document.getElementById("billTotalTip").innerHTML =
    `Total bills: <strong>${fmt(draft.billsTotal)}</strong>`;

  sfxTap();
  go("screen-paidBills");
}

function applyPlan(planKey){
  // collect pay
  state.cash += draft.paycheck + plannerBonus();

  // pay bills
  const billCost = draft.billsTotal;
  if(state.cash >= billCost){
    state.cash -= billCost;
  }else{
    const gap = billCost - state.cash;
    state.cash = 0;
    state.debt += gap;
  }

  const available = state.cash;

  let saveP=0.50, invP=0.20;
  if(planKey === "balanced"){ saveP=0.35; invP=0.35; }
  if(planKey === "bold"){ saveP=0.20; invP=0.55; }

  const save = Math.round(available * saveP);
  const inv  = Math.round(available * invP);
  const spend= Math.max(0, available - save - inv);

  state.cash -= (save + inv + spend);
  state.savings += save;
  state.invest += inv;

  draft.planName = (planKey === "safe" ? "Safe" : planKey === "balanced" ? "Balanced" : "Bold");
  draft.save = save; draft.invest = inv; draft.spend = spend;

  sfxTap();

  drawSurprise();

  // auto-advance to surprise
  setTimeout(() => go("screen-surprise"), 220);
}

function drawSurprise(){
  const s = SURPRISES[rint(draft.rng, 0, SURPRISES.length - 1)];
  draft.surprise = s;

  document.getElementById("surpriseChoices").style.display = "none";
  document.getElementById("surpriseTip").textContent = "After this, we show your results.";

  if(s.kind === "cash"){
    let impact = rint(draft.rng, s.min, s.max);
    if(impact < 0) impact = softenBadCost(impact);
    draft.surpriseText = (impact >= 0) ? `You got ${fmt(impact)}.` : `You owe ${fmt(-impact)}.`;

    if(impact >= 0){
      state.cash += impact;
    }else{
      const cost = -impact;
      if(state.cash >= cost){
        state.cash -= cost;
      }else{
        const gap = cost - state.cash;
        state.cash = 0;
        state.debt += gap;
      }
    }
  }

  if(s.kind === "market"){
    let pct = improveInvestPct(rfloat(draft.rng, s.min, s.max));
    draft.surpriseText = `Your invest money changed by ${(pct*100).toFixed(1)}%.`;
    state.invest = Math.round(state.invest * (1 + pct));
  }

  if(s.kind === "choice"){
    draft.surpriseText = `Do you go out for ${fmt(s.cost)}?`;
    document.getElementById("surpriseChoices").style.display = "grid";
    document.getElementById("goOutCost").textContent = `Costs ${fmt(s.cost)}`;
    document.getElementById("surpriseTip").textContent = "Pick one. Then we move on automatically.";
  }

  document.getElementById("surpriseText").innerHTML =
    `<strong>${s.name}</strong><br/>${draft.surpriseText}`;

  hud();
}

function resolveChoice(choice){
  const s = draft.surprise;
  if(!s || s.kind !== "choice") return;

  const cost = s.cost;

  if(choice === "go"){
    if(state.cash >= cost){
      state.cash -= cost;
      draft.choiceResult = `You went out. (-${fmt(cost)})`;
    }else{
      const gap = cost - state.cash;
      state.cash = 0;
      state.debt += gap;
      draft.choiceResult = `You went out, but you didn’t have enough cash. Debt +${fmt(gap)}.`;
    }
  }else{
    draft.choiceResult = "You stayed in. ($0)";
  }

  sfxTap();
  setTimeout(() => showResults(), 320);
}

function applyGrowthAndInterest(){
  draft.saveBefore = state.savings;
  state.savings = Math.round(state.savings * (1 + SAVINGS_GROWTH));
  draft.saveAfter = state.savings;

  const pct = improveInvestPct(rfloat(draft.rng, INV_MIN, INV_MAX));
  draft.invPct = pct;
  draft.invBefore = state.invest;
  state.invest = Math.round(state.invest * (1 + pct));
  draft.invAfter = state.invest;

  if(state.debt > 0){
    state.debt = Math.round(state.debt * (1 + DEBT_INTEREST));
  }
}

function showResults(){
  if(draft.surprise && draft.surprise.kind === "choice" && !draft.choiceResult){
    return;
  }

  applyGrowthAndInterest();

  const after = moneyScore();
  draft.afterScore = after;

  // streak
  const goodRound = (state.debt === 0) || (draft.planName !== "Bold" && state.debt < 200);
  const prevStreak = state.streak;
  state.streak = goodRound ? state.streak + 1 : 0;

  const delta = after - draft.beforeScore;
  const sign = delta >= 0 ? "+" : "-";
  const cls = delta >= 0 ? "good" : "bad";

  document.getElementById("resultText").innerHTML = `
    Score change: <strong class="${cls}">${sign}${fmt(Math.abs(delta))}</strong><br/>
    Plan: <strong>${draft.planName}</strong> | Saved <strong>${fmt(draft.save)}</strong> | Invested <strong>${fmt(draft.invest)}</strong> | Spent <strong>${fmt(draft.spend)}</strong><br/>
    ${draft.choiceResult ? `Choice: <strong>${draft.choiceResult}</strong><br/>` : ""}
    Savings grew: <strong>${fmt(draft.saveBefore)} → ${fmt(draft.saveAfter)}</strong><br/>
    Invest moved: <strong>${(draft.invPct*100).toFixed(1)}%</strong> (${fmt(draft.invBefore)} → ${fmt(draft.invAfter)})
  `;

  const tip = draft.surprise?.tip || MICRO_TIPS[rint(draft.rng, 0, MICRO_TIPS.length - 1)];
  document.getElementById("resultTip").textContent = "Tip: " + tip;
  setTip(tip);

  // ledger
  log(`\nROUND ${state.round}/${TOTAL_ROUNDS}`);
  log(`Paid: ${draft.jobName} (+${fmt(draft.paycheck)})${plannerBonus() ? ` + bonus (+${fmt(plannerBonus())})` : ""}`);
  log(`Bills total: -${fmt(draft.billsTotal)} | ${draft.billsItems.map(b=>`${b.name} ${fmt(b.amount)}`).join(", ")}`);
  log(`Plan: ${draft.planName} | Save ${fmt(draft.save)} | Invest ${fmt(draft.invest)} | Spend ${fmt(draft.spend)}`);
  if(draft.surprise) log(`Surprise: ${draft.surprise.name} — ${draft.surpriseText}`);
  if(draft.choiceResult) log(`Choice: ${draft.choiceResult}`);
  log(`Savings: ${fmt(draft.saveBefore)} → ${fmt(draft.saveAfter)}`);
  log(`Invest: ${(draft.invPct*100).toFixed(1)}% | ${fmt(draft.invBefore)} → ${fmt(draft.invAfter)}`);
  if(state.debt > 0) log(`Debt: ${fmt(state.debt)}`);
  log(`Score: ${fmt(after)} | Streak: ${state.streak}`);

  // Streak confetti milestones
  if(state.streak === 3 || state.streak === 5 || state.streak === 10){
    launchConfetti(160);
    sfxWin();
    log(`Streak bonus moment: ${state.streak} in a row!`);
  } else {
    // simple audio feedback
    if(delta >= 0) sfxWin();
    else sfxLose();
  }

  // Goal completion check (also triggers confetti)
  const justCompletedGoal = checkGoalCompletion();
  if(justCompletedGoal){
    launchConfetti(220);
    sfxWin();
    const g = GOALS.find(x => x.id === state.goalId);
    if(g){
      log(`GOAL COMPLETE: ${g.label}`);
    }
    setTip("Goal complete! Keep going.");
  }

  hud();
  go("screen-result");

  // If surprise wasn't a choice, auto-advance to results after ~0.8s from showing surprise
  // (Handled by observer below)
}

function nextRound(){
  state.round += 1;
  draft = null;

  if(state.round > TOTAL_ROUNDS){
    const score = moneyScore();
    document.getElementById("finishText").innerHTML =
      `You finished <strong>${TOTAL_ROUNDS}</strong> rounds.<br/>Final Score: <strong class="${score>=0?"good":"bad"}">${fmt(score)}</strong>` +
      `<br/><br/>Goal status: <strong>${state.goalCompleted ? "Completed" : "Not completed (try again!)"}</strong>`;
    go("screen-finish");
    return;
  }

  hud();
  go("screen-startRound");
}

/* ====== LEVEL UP ====== */
function levelUp(){
  if(state.level >= LEVELS.length - 1) return;
  const next = state.level + 1;
  const cost = LEVELS[next].cost;
  if(state.cash < cost){
    alert(`You need ${fmt(cost)} cash to level up.`);
    return;
  }
  state.cash -= cost;
  state.level = next;
  log(`Leveled up: ${LEVELS[state.level].name} (-${fmt(cost)})`);
  log(`Perk: ${LEVELS[state.level].perk}`);
  setTip(LEVELS[state.level].perk);
  sfxTap();
  hud();
}

/* ====== SAVE/LOAD ====== */
function saveGame(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ state, soundOn }));
  log("Saved game to this browser.");
  sfxTap();
}
function loadGame(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert("No saved game found."); return; }
  try{
    const parsed = JSON.parse(raw);
    state = parsed.state;
    soundOn = !!parsed.soundOn;
    setSoundUI();
    draft = null;
    hud();
    log("\nLoaded saved game.");
    go("screen-startRound");
  }catch(e){
    alert("Could not load.");
  }
}
function resetGame(){
  if(!confirm("Reset the game?")) return;
  document.getElementById("log").textContent = "";
  newGame();
}

/* ====== AVATAR SETUP ====== */
function buildPalette(){
  const p = document.getElementById("palette");
  p.innerHTML = "";
  AVATAR_COLORS.forEach((c, idx) => {
    const d = document.createElement("div");
    d.className = "colorPick";
    d.style.background = c;
    d.title = c;
    d.onclick = () => {
      sfxTap();
      state.avatarColor = c;
      document.querySelectorAll(".colorPick").forEach(x => x.classList.remove("selected"));
      d.classList.add("selected");
      hud();
    };
    if(idx === 0) d.classList.add("selected");
    p.appendChild(d);
  });
}

/* ====== SOUND TOGGLE UI ====== */
function setSoundUI(){
  const el = document.getElementById("soundToggle");
  if(soundOn){
    el.classList.add("on");
    el.setAttribute("aria-checked", "true");
  }else{
    el.classList.remove("on");
    el.setAttribute("aria-checked", "false");
  }
}
function toggleSound(){
  soundOn = !soundOn;
  setSoundUI();
  if(soundOn){
    // on first enable, create context and play a tiny confirm beep
    ensureAudio();
    sfxTap();
  }
}

/* ====== BUTTONS ====== */
document.getElementById("btnIntroNext").onclick = () => { sfxTap(); go("screen-setup"); };
document.getElementById("btnIntroHow").onclick = () => { sfxTap(); go("screen-how"); };

document.getElementById("btnHowBack").onclick = () => { sfxTap(); go("screen-intro"); };
document.getElementById("btnHowNext").onclick = () => { sfxTap(); go("screen-setup"); };

document.getElementById("btnSetupBack").onclick = () => { sfxTap(); go("screen-intro"); };
document.getElementById("btnSetupStart").onclick = () => {
  state.name = (document.getElementById("playerName").value.trim() || "Player 1");
  log(`Player set: ${state.name}`);
  hud();
  sfxTap();
  go("screen-startRound");
};

document.getElementById("btnStartRound").onclick = () => startRound();

document.getElementById("btnPaidContinue").onclick = () => {
  const after = Math.max(0, state.cash + draft.paycheck + plannerBonus() - draft.billsTotal);
  document.getElementById("planPreview").innerHTML =
    `After bills, you’ll have about <strong>${fmt(after)}</strong>. Pick a plan:`;
  sfxTap();
  go("screen-plan");
};

document.getElementById("planSafe").onclick = () => applyPlan("safe");
document.getElementById("planBalanced").onclick = () => applyPlan("balanced");
document.getElementById("planBold").onclick = () => applyPlan("bold");

document.getElementById("btnGoOut").onclick = () => resolveChoice("go");
document.getElementById("btnStayIn").onclick = () => resolveChoice("stay");

// Auto-advance from surprise to results if not a choice
const surpriseObserver = new MutationObserver(() => {
  if(!draft || !draft.surprise) return;
  if(draft.surprise.kind !== "choice"){
    setTimeout(() => showResults(), 800);
  }
});
surpriseObserver.observe(document.getElementById("surpriseText"), { childList:true, subtree:true });

document.getElementById("btnNextRound").onclick = () => { sfxTap(); nextRound(); };
document.getElementById("btnPlayAgain").onclick = () => resetGame();
document.getElementById("btnSaveRun").onclick = () => saveGame();

document.getElementById("btnSkill").onclick = () => levelUp();
document.getElementById("btnSave").onclick = () => saveGame();
document.getElementById("btnLoad").onclick = () => loadGame();
document.getElementById("btnReset").onclick = () => resetGame();

document.getElementById("soundToggle").onclick = () => toggleSound();
document.getElementById("soundToggle").addEventListener("keydown", (e) => {
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    toggleSound();
  }
});

/* ====== BOOT ====== */
newGame();
buildPalette();
document.getElementById("screen-intro").classList.add("active");
setSoundUI();
hud();
</script>
</body>
</html>
