<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Money Lab — Tap Card Game</title>
  <style>
    :root{
      --bg:#070a16;
      --panel:#101834;
      --text:#eef1ff;
      --muted:#aab3da;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --good:#5ee6a8;
      --bad:#ff6b7a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(7,10,22,.75);
      border-bottom: 1px solid var(--line);
      padding: 14px 16px;
    }
    header .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width: 1100px; margin:0 auto;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35; }
    main{ max-width:1100px; margin:0 auto; padding: 16px; }

    .hud{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-bottom: 14px;
    }
    @media (max-width: 980px){
      .hud{ grid-template-columns: repeat(3, 1fr); }
    }
    .kpi{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 62px;
    }
    .kpi .t{ font-size:11px; color:var(--muted); }
    .kpi .v{ margin-top:6px; font-weight:900; letter-spacing:.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
      min-height: 420px;
    }
    .side{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card{
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      padding: 14px;
    }
    .bigTitle{ font-size: 20px; font-weight: 950; margin: 0 0 6px; }
    .bigBody{ color: var(--muted); line-height: 1.45; }

    button{
      border-radius: 16px;
      border:1px solid rgba(122,162,255,.65);
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      color: var(--text);
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      width:100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-align:left;
    }
    button.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight: 800;
    }
    button.danger{
      border-color: rgba(255,107,122,.65);
      background: linear-gradient(180deg, rgba(255,107,122,.95), rgba(255,107,122,.70));
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btnRow .half{ flex:1 1 220px; }
    .btnRow .third{ flex:1 1 160px; }

    input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }

    .choiceGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (min-width: 860px){
      .choiceGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .tip{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .pill{
      display:inline-block;
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      font-size: 12px;
      font-weight: 900;
      margin-right: 8px;
    }
    .progressWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
      height: 10px;
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(94,230,168,.95), rgba(122,162,255,.95));
    }
    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      max-height: 360px;
      overflow:auto;
    }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    /* Screens */
    .screen{
      position:absolute;
      inset:0;
      padding: 14px;
      transform: translateX(110%);
      opacity: 0;
      transition: transform .35s ease, opacity .35s ease;
    }
    .screen.active{
      transform: translateX(0%);
      opacity: 1;
    }
    .screen.left{
      transform: translateX(-110%);
      opacity: 0;
    }

    ul.clean{ margin:10px 0 0 18px; color:var(--muted); }
    .billList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .billItem{
      display:flex; justify-content:space-between; gap:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .billItem strong{ color: var(--text); }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Money Lab — Tap Card Game</h1>
      <div class="sub">Fast rounds. Tap choices. Learn by doing.</div>
    </div>
    <div style="width:260px; max-width:40vw;">
      <div class="sub">Seed (optional)</div>
      <input id="seed" type="text" placeholder="e.g., 2026" />
    </div>
  </div>
</header>

<main>
  <section class="hud" aria-label="HUD">
    <div class="kpi"><div class="t">Round</div><div class="v" id="kRound">—</div></div>
    <div class="kpi"><div class="t">Level</div><div class="v" id="kLevel">—</div></div>
    <div class="kpi"><div class="t">Cash</div><div class="v" id="kCash">—</div></div>
    <div class="kpi"><div class="t">Savings</div><div class="v" id="kSave">—</div></div>
    <div class="kpi"><div class="t">Invest</div><div class="v" id="kInv">—</div></div>
    <div class="kpi"><div class="t">Debt / Score</div><div class="v" id="kDebtScore">—</div></div>
  </section>

  <div class="grid">
    <!-- MAIN (MULTI-SCREEN) -->
    <section class="panel" aria-label="App screens">
      <div class="screen" id="screen-intro">
        <div class="card">
          <div class="bigTitle">Welcome to Money Lab</div>
          <div class="bigBody">
            This is a quick money game that teaches real life skills:
            <strong>pay bills</strong>, <strong>save</strong>, and <strong>invest</strong> — without boring math.
          </div>
          <div class="btnRow">
            <button class="half" id="btnIntroNext">Enter</button>
            <button class="secondary half" id="btnIntroHow">How to play</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-how">
        <div class="card">
          <div class="bigTitle">How to play (3 steps)</div>
          <ul class="clean">
            <li>You get paid.</li>
            <li>You pay bills.</li>
            <li>You tap a plan (Safe / Balanced / Bold), then handle a surprise.</li>
          </ul>
          <div class="tip">Tip: Saving a little first makes surprises hurt less.</div>
          <div class="btnRow">
            <button class="secondary half" id="btnHowBack">Back</button>
            <button class="half" id="btnHowNext">Continue</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-setup">
        <div class="card">
          <div class="bigTitle">Pick your player</div>
          <div class="bigBody">Type your name and tap Start.</div>
          <div style="margin-top:10px;">
            <div class="sub">Name</div>
            <input id="playerName" type="text" value="Player 1" />
          </div>
          <div class="btnRow">
            <button class="secondary half" id="btnSetupBack">Back</button>
            <button class="half" id="btnSetupStart">Start Game</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-startRound">
        <div class="card">
          <div class="bigTitle">Ready?</div>
          <div class="bigBody">Tap Start Round. You’ll get paid, pay bills, and make a quick choice.</div>
          <div class="btnRow">
            <button class="half" id="btnStartRound">Start Round</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-paidBills">
        <div class="card">
          <div class="bigTitle">You got paid</div>
          <div class="bigBody" id="paidText">—</div>

          <div class="hr"></div>

          <div class="bigTitle">Bills</div>
          <div class="bigBody">Here’s what you have to pay today:</div>
          <div class="billList" id="billList"></div>
          <div class="tip" id="billTotalTip">Total bills: —</div>

          <div class="btnRow">
            <button class="half" id="btnPaidContinue">Continue</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-plan">
        <div class="card">
          <div class="bigTitle">Pick a plan</div>
          <div class="bigBody" id="planPreview">—</div>

          <div class="choiceGrid">
            <button id="planSafe">
              <div>SAFE</div>
              <div class="sub">Save a lot. Invest a little. Spend a little.</div>
            </button>
            <button id="planBalanced">
              <div>BALANCED</div>
              <div class="sub">Save some. Invest some. Spend some.</div>
            </button>
            <button id="planBold">
              <div>BOLD</div>
              <div class="sub">Invest a lot. Save a little. Spend a little.</div>
            </button>
          </div>

          <div class="tip">Auto-advance: after you tap a plan, you’ll go straight to the surprise card.</div>
        </div>
      </div>

      <div class="screen" id="screen-surprise">
        <div class="card">
          <div class="bigTitle">Surprise card</div>
          <div class="bigBody" id="surpriseText">—</div>

          <div class="choiceGrid" id="surpriseChoices" style="display:none;">
            <button id="btnGoOut"><div>Go out</div><div class="sub" id="goOutCost">Costs —</div></button>
            <button id="btnStayIn" class="secondary"><div>Stay in</div><div class="sub">Costs $0</div></button>
            <button class="secondary" disabled><div>Pick one</div><div class="sub">Then we move on.</div></button>
          </div>

          <div class="tip" id="surpriseTip">After this, we show your results.</div>
        </div>
      </div>

      <div class="screen" id="screen-result">
        <div class="card">
          <div class="bigTitle">Round results</div>
          <div class="bigBody" id="resultText">—</div>
          <div class="tip" id="resultTip">—</div>
          <div class="btnRow">
            <button class="half" id="btnNextRound">Next Round</button>
          </div>
        </div>
      </div>

      <div class="screen" id="screen-finish">
        <div class="card">
          <div class="bigTitle">Game complete</div>
          <div class="bigBody" id="finishText">—</div>
          <div class="btnRow">
            <button class="danger half" id="btnPlayAgain">Play again</button>
            <button class="secondary half" id="btnSaveRun">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <section class="side" aria-label="Progress + Ledger">
      <div class="card">
        <div class="pill" id="pillStreak">Streak: 0</div>
        <div class="pill" id="pillGoal">Goal: 20 rounds</div>
        <div class="progressWrap" aria-label="Progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="tip" id="tipBox">Tip: Save a little first. Future you will be grateful.</div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <div class="bigTitle" style="font-size:16px;">Ledger</div>
        <div id="log" class="log"></div>
      </div>

      <div class="btnRow">
        <button class="secondary third" id="btnSkill">Level up money skills</button>
        <button class="secondary third" id="btnSave">Save</button>
        <button class="secondary third" id="btnLoad">Load</button>
        <button class="danger third" id="btnReset">Reset</button>
      </div>
    </section>
  </div>
</main>

<script>
/* ====== SETTINGS ====== */
const TOTAL_ROUNDS = 20;

const BILLS_DECK = [
  { name: "Phone bill", min: 10, max: 35 },
  { name: "Transportation", min: 8, max: 30 },
  { name: "Lunch/snacks", min: 5, max: 22 },
  { name: "Subscription", min: 5, max: 15 },
  { name: "Supplies", min: 8, max: 25 },
  { name: "Family errand", min: 6, max: 20 }
];

const SAVINGS_GROWTH = 0.01;
const INV_MIN = -0.06;
const INV_MAX =  0.12;
const DEBT_INTEREST = 0.03;

const LEVELS = [
  { name: "Rookie",    perk: "No perk yet. You’re learning.",               cost: 0 },
  { name: "Saver",     perk: "Bad surprises cost a little less.",          cost: 250 },
  { name: "Planner",   perk: "You get a small bonus each round.",          cost: 350 },
  { name: "Investor",  perk: "Your invest results are slightly better.",   cost: 450 },
  { name: "Boss",      perk: "You lose less on bad luck days.",            cost: 600 }
];

const PAYCHECKS = [
  { name: "Babysitting", min: 60, max: 140 },
  { name: "Part-time shift", min: 90, max: 180 },
  { name: "Gig job", min: 50, max: 220 },
  { name: "Small hustle", min: 40, max: 260 },
  { name: "Weekend work", min: 80, max: 210 }
];

const SURPRISES = [
  { name: "Phone screen cracked", kind:"cash", min:-70, max:-30, tip:"Stuff breaks. Savings helps." },
  { name: "Friend invites you out", kind:"choice", cost:25, tip:"Fun is fine — plan for it." },
  { name: "Lost something (replace it)", kind:"cash", min:-45, max:-15, tip:"Small leaks add up." },
  { name: "You got a small bonus", kind:"cash", min:25, max:80, tip:"Don’t blow wins — build wins." },
  { name: "Market dip", kind:"market", min:-0.08, max:-0.03, tip:"Investing goes down sometimes. That’s normal." },
  { name: "Market pop", kind:"market", min:0.03, max:0.10, tip:"Good days happen. Don’t get reckless." },
  { name: "Someone pays you back", kind:"cash", min:20, max:65, tip:"When money returns, save some." },
  { name: "Emergency bill", kind:"cash", min:-60, max:-20, tip:"Unexpected bills are real. Buffer matters." }
];

const MICRO_TIPS = [
  "Save a little first. Future you will be grateful.",
  "Debt grows if you ignore it.",
  "Investing can go up or down. That’s normal.",
  "A plan beats vibes every time.",
  "Cash is for now. Savings is for later.",
  "If you have no buffer, one surprise can wreck you."
];

const STORAGE_KEY = "moneyLabMultiScreenSave_v1";

/* ====== UTILS ====== */
const fmt = (n) => {
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 0 });
};

function mulberry32(a){
  return function(){
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function getRoundRng(round){
  const s = document.getElementById("seed").value.trim();
  if(!s) return Math.random;
  const n = Number(s);
  if(!Number.isFinite(n)) return Math.random;
  return mulberry32((n + round * 101) >>> 0);
}
function rint(rng, min, max){
  return Math.floor(rng() * (max - min + 1)) + min;
}
function rfloat(rng, min, max){
  return rng() * (max - min) + min;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* ====== STATE ====== */
let state = null;
let draft = null;

function levelName(){ return LEVELS[clamp(state.level,0,LEVELS.length-1)].name; }
function moneyScore(){
  return Math.round((state.cash + state.savings + state.invest) - (state.debt * 1.2) + (state.streak * 10));
}
function log(line){
  state.log.push(line);
  const el = document.getElementById("log");
  el.textContent = state.log.join("\n");
  el.scrollTop = el.scrollHeight;
}
function setTip(text){
  document.getElementById("tipBox").textContent = "Tip: " + text;
}
function hud(){
  const score = moneyScore();
  document.getElementById("kRound").textContent = `${state.round}/${TOTAL_ROUNDS}`;
  document.getElementById("kLevel").textContent = `${levelName()} (Lv ${state.level+1})`;
  document.getElementById("kCash").textContent = fmt(state.cash);
  document.getElementById("kSave").textContent = fmt(state.savings);
  document.getElementById("kInv").textContent = fmt(state.invest);
  document.getElementById("kDebtScore").innerHTML =
    `<span class="${state.debt>0 ? "bad":"sub"}">${fmt(state.debt)}</span>
     <span class="sub"> / </span>
     <span class="${score>=0 ? "good":"bad"}">${fmt(score)}</span>`;

  document.getElementById("pillStreak").textContent = `Streak: ${state.streak}`;
  document.getElementById("pillGoal").textContent = `Goal: ${TOTAL_ROUNDS} rounds`;

  const pct = Math.round((state.round-1) / TOTAL_ROUNDS * 100);
  document.getElementById("progressBar").style.width = `${pct}%`;
}

/* ====== SCREEN NAV ====== */
let currentScreenId = "screen-intro";
function go(screenId){
  const current = document.getElementById(currentScreenId);
  const next = document.getElementById(screenId);
  if(!current || !next) return;

  // slide current left
  current.classList.remove("active");
  current.classList.add("left");

  // reset other screens
  document.querySelectorAll(".screen").forEach(s => {
    if(s.id !== screenId && s.id !== currentScreenId){
      s.classList.remove("active");
      s.classList.remove("left");
    }
  });

  // show next
  next.classList.add("active");
  next.classList.remove("left");

  // clean up current after animation
  setTimeout(() => {
    current.classList.remove("left");
  }, 360);

  currentScreenId = screenId;
}

/* ====== GAME MECHANICS ====== */
function plannerBonus(){
  return (state.level >= 2) ? 10 : 0;
}
function softenBadCost(amount){
  const reduce = 0.04 * state.level;
  return Math.round(amount * (1 - reduce));
}
function improveInvestPct(pct){
  return pct + 0.01 * state.level;
}

function newGame(){
  state = {
    name: "Player 1",
    round: 1,
    level: 0,
    streak: 0,
    cash: 100,
    savings: 0,
    invest: 0,
    debt: 0,
    log: []
  };
  draft = null;
  setTip(MICRO_TIPS[0]);
  log("New game started. You start with $100 cash.");
  hud();
  go("screen-intro");
}

function buildBills(rng){
  const nBills = rint(rng, 2, 4);
  const picked = [];
  const used = new Set();
  while(picked.length < nBills){
    const b = BILLS_DECK[rint(rng, 0, BILLS_DECK.length - 1)];
    if(used.has(b.name)) continue;
    used.add(b.name);
    picked.push({ name: b.name, amount: rint(rng, b.min, b.max) });
  }
  const total = picked.reduce((s,x) => s + x.amount, 0);
  return { items: picked, total };
}

function startRound(){
  const rng = getRoundRng(state.round);

  const job = PAYCHECKS[rint(rng, 0, PAYCHECKS.length - 1)];
  const paycheck = rint(rng, job.min, job.max);

  const bills = buildBills(rng);

  draft = {
    rng,
    jobName: job.name,
    paycheck,
    billsItems: bills.items,
    billsTotal: bills.total,

    planName: "",
    save: 0, invest: 0, spend: 0,

    surprise: null,
    surpriseText: "",
    choiceResult: null,

    // result snapshots
    beforeScore: moneyScore(),
    afterScore: null,
    saveBefore: null, saveAfter: null,
    invBefore: null, invAfter: null,
    invPct: 0
  };

  // Fill Paid/Bills screen UI
  document.getElementById("paidText").innerHTML =
    `Job: <strong>${draft.jobName}</strong><br/>Paycheck: <strong>${fmt(draft.paycheck)}</strong>` +
    (plannerBonus() ? `<br/>Bonus (perk): <strong>+${fmt(plannerBonus())}</strong>` : "");

  const list = document.getElementById("billList");
  list.innerHTML = "";
  draft.billsItems.forEach(b => {
    const div = document.createElement("div");
    div.className = "billItem";
    div.innerHTML = `<span>${b.name}</span><strong>${fmt(b.amount)}</strong>`;
    list.appendChild(div);
  });
  document.getElementById("billTotalTip").innerHTML =
    `Total bills: <strong>${fmt(draft.billsTotal)}</strong>`;

  go("screen-paidBills");
}

function applyPlan(planKey){
  // collect pay
  state.cash += draft.paycheck + plannerBonus();

  // pay bills
  const billCost = draft.billsTotal;
  if(state.cash >= billCost){
    state.cash -= billCost;
  }else{
    const gap = billCost - state.cash;
    state.cash = 0;
    state.debt += gap;
  }

  const available = state.cash;

  let saveP=0.50, invP=0.20;
  if(planKey === "balanced"){ saveP=0.35; invP=0.35; }
  if(planKey === "bold"){ saveP=0.20; invP=0.55; }

  const save = Math.round(available * saveP);
  const inv  = Math.round(available * invP);
  const spend= Math.max(0, available - save - inv);

  state.cash -= (save + inv + spend);
  state.savings += save;
  state.invest += inv;

  draft.planName = (planKey === "safe" ? "Safe" : planKey === "balanced" ? "Balanced" : "Bold");
  draft.save = save; draft.invest = inv; draft.spend = spend;

  // Draw surprise immediately and auto-advance
  drawSurprise();

  // Auto-advance to surprise after a short delay (for feel)
  setTimeout(() => {
    go("screen-surprise");
  }, 250);
}

function drawSurprise(){
  const s = SURPRISES[rint(draft.rng, 0, SURPRISES.length - 1)];
  draft.surprise = s;

  document.getElementById("surpriseChoices").style.display = "none";
  document.getElementById("surpriseTip").textContent = "After this, we show your results.";

  if(s.kind === "cash"){
    let impact = rint(draft.rng, s.min, s.max);
    if(impact < 0) impact = softenBadCost(impact);
    draft.surpriseText = (impact >= 0) ? `You got ${fmt(impact)}.` : `You owe ${fmt(-impact)}.`;

    if(impact >= 0){
      state.cash += impact;
    }else{
      const cost = -impact;
      if(state.cash >= cost){
        state.cash -= cost;
      }else{
        const gap = cost - state.cash;
        state.cash = 0;
        state.debt += gap;
      }
    }
  }

  if(s.kind === "market"){
    let pct = rfloat(draft.rng, s.min, s.max);
    pct = improveInvestPct(pct);
    draft.surpriseText = `Your invest money changed by ${(pct*100).toFixed(1)}%.`;
    state.invest = Math.round(state.invest * (1 + pct));
  }

  if(s.kind === "choice"){
    draft.surpriseText = `Do you go out for ${fmt(s.cost)}?`;
    document.getElementById("surpriseChoices").style.display = "grid";
    document.getElementById("goOutCost").textContent = `Costs ${fmt(s.cost)}`;
    document.getElementById("surpriseTip").textContent = "Pick one. Then we move on automatically.";
  }

  document.getElementById("surpriseText").innerHTML =
    `<strong>${s.name}</strong><br/>${draft.surpriseText}`;
}

function resolveChoice(choice){
  const s = draft.surprise;
  if(!s || s.kind !== "choice") return;

  const cost = s.cost;

  if(choice === "go"){
    if(state.cash >= cost){
      state.cash -= cost;
      draft.choiceResult = `You went out. (-${fmt(cost)})`;
    }else{
      const gap = cost - state.cash;
      state.cash = 0;
      state.debt += gap;
      draft.choiceResult = `You went out, but you didn’t have enough cash. Debt +${fmt(gap)}.`;
    }
  }else{
    draft.choiceResult = "You stayed in. ($0)";
  }

  // Auto-advance to results after short delay
  setTimeout(() => showResults(), 350);
}

function applyGrowthAndInterest(){
  draft.saveBefore = state.savings;
  state.savings = Math.round(state.savings * (1 + SAVINGS_GROWTH));
  draft.saveAfter = state.savings;

  const pct = improveInvestPct(rfloat(draft.rng, INV_MIN, INV_MAX));
  draft.invPct = pct;
  draft.invBefore = state.invest;
  state.invest = Math.round(state.invest * (1 + pct));
  draft.invAfter = state.invest;

  if(state.debt > 0){
    state.debt = Math.round(state.debt * (1 + DEBT_INTEREST));
  }
}

function showResults(){
  // If we had a choice surprise, ensure it was chosen
  if(draft.surprise && draft.surprise.kind === "choice" && !draft.choiceResult){
    return; // wait
  }

  applyGrowthAndInterest();

  const after = moneyScore();
  draft.afterScore = after;

  // streak rule (simple)
  const goodRound = (state.debt === 0) || (draft.planName !== "Bold" && state.debt < 200);
  state.streak = goodRound ? state.streak + 1 : 0;

  // Update result UI
  const delta = after - draft.beforeScore;
  const sign = delta >= 0 ? "+" : "-";
  const cls = delta >= 0 ? "good" : "bad";

  document.getElementById("resultText").innerHTML = `
    Score change: <strong class="${cls}">${sign}${fmt(Math.abs(delta))}</strong><br/>
    Plan: <strong>${draft.planName}</strong> | Saved <strong>${fmt(draft.save)}</strong> | Invested <strong>${fmt(draft.invest)}</strong> | Spent <strong>${fmt(draft.spend)}</strong><br/>
    ${draft.choiceResult ? `Choice: <strong>${draft.choiceResult}</strong><br/>` : ""}
    Savings grew: <strong>${fmt(draft.saveBefore)} → ${fmt(draft.saveAfter)}</strong><br/>
    Invest moved: <strong>${(draft.invPct*100).toFixed(1)}%</strong> (${fmt(draft.invBefore)} → ${fmt(draft.invAfter)})
  `;

  const tip = draft.surprise?.tip || MICRO_TIPS[rint(draft.rng, 0, MICRO_TIPS.length - 1)];
  document.getElementById("resultTip").textContent = "Tip: " + tip;
  setTip(tip);

  // log
  log(`\nROUND ${state.round}/${TOTAL_ROUNDS}`);
  log(`Paid: ${draft.jobName} (+${fmt(draft.paycheck)})${plannerBonus() ? ` + bonus (+${fmt(plannerBonus())})` : ""}`);
  log(`Bills total: -${fmt(draft.billsTotal)} | ${draft.billsItems.map(b=>`${b.name} ${fmt(b.amount)}`).join(", ")}`);
  log(`Plan: ${draft.planName} | Save ${fmt(draft.save)} | Invest ${fmt(draft.invest)} | Spend ${fmt(draft.spend)}`);
  if(draft.surprise) log(`Surprise: ${draft.surprise.name} — ${draft.surpriseText}`);
  if(draft.choiceResult) log(`Choice: ${draft.choiceResult}`);
  log(`Savings: ${fmt(draft.saveBefore)} → ${fmt(draft.saveAfter)}`);
  log(`Invest: ${(draft.invPct*100).toFixed(1)}% | ${fmt(draft.invBefore)} → ${fmt(draft.invAfter)}`);
  if(state.debt > 0) log(`Debt: ${fmt(state.debt)}`);
  log(`Score: ${fmt(after)} | Streak: ${state.streak}`);

  hud();

  go("screen-result");
}

function nextRound(){
  state.round += 1;
  draft = null;

  if(state.round > TOTAL_ROUNDS){
    const score = moneyScore();
    document.getElementById("finishText").innerHTML =
      `You finished <strong>${TOTAL_ROUNDS}</strong> rounds.<br/>Final Score: <strong class="${score>=0?"good":"bad"}">${fmt(score)}</strong>`;
    go("screen-finish");
    return;
  }

  go("screen-startRound");
}

/* ====== LEVEL UP ====== */
function levelUp(){
  if(state.level >= LEVELS.length - 1) return;
  const next = state.level + 1;
  const cost = LEVELS[next].cost;
  if(state.cash < cost){
    alert(`You need ${fmt(cost)} cash to level up.`);
    return;
  }
  state.cash -= cost;
  state.level = next;
  log(`Leveled up: ${LEVELS[state.level].name} (-${fmt(cost)})`);
  log(`Perk: ${LEVELS[state.level].perk}`);
  setTip(LEVELS[state.level].perk);
  hud();
}

/* ====== SAVE/LOAD ====== */
function saveGame(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ state }));
  log("Saved game to this browser.");
}
function loadGame(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert("No saved game found."); return; }
  try{
    const parsed = JSON.parse(raw);
    state = parsed.state;
    draft = null;
    hud();
    log("\nLoaded saved game.");
    go("screen-startRound");
  }catch(e){
    alert("Could not load.");
  }
}
function resetGame(){
  if(!confirm("Reset the game?")) return;
  document.getElementById("log").textContent = "";
  newGame();
}

/* ====== BUTTONS ====== */
document.getElementById("btnIntroNext").onclick = () => go("screen-setup");
document.getElementById("btnIntroHow").onclick = () => go("screen-how");

document.getElementById("btnHowBack").onclick = () => go("screen-intro");
document.getElementById("btnHowNext").onclick = () => go("screen-setup");

document.getElementById("btnSetupBack").onclick = () => go("screen-intro");
document.getElementById("btnSetupStart").onclick = () => {
  state.name = (document.getElementById("playerName").value.trim() || "Player 1");
  log(`Player set: ${state.name}`);
  hud();
  go("screen-startRound");
};

document.getElementById("btnStartRound").onclick = () => startRound();
document.getElementById("btnPaidContinue").onclick = () => {
  const after = Math.max(0, state.cash + draft.paycheck + plannerBonus() - draft.billsTotal);
  document.getElementById("planPreview").innerHTML =
    `After bills, you’ll have about <strong>${fmt(after)}</strong>. Pick a plan:`;
  go("screen-plan");
};

document.getElementById("planSafe").onclick = () => applyPlan("safe");
document.getElementById("planBalanced").onclick = () => applyPlan("balanced");
document.getElementById("planBold").onclick = () => applyPlan("bold");

document.getElementById("btnGoOut").onclick = () => resolveChoice("go");
document.getElementById("btnStayIn").onclick = () => resolveChoice("stay");

// If surprise isn't a choice, auto-advance to results after 0.8s
const surpriseObserver = new MutationObserver(() => {
  if(!draft || !draft.surprise) return;
  if(draft.surprise.kind !== "choice"){
    setTimeout(() => showResults(), 800);
  }
});
surpriseObserver.observe(document.getElementById("surpriseText"), { childList:true, subtree:true });

document.getElementById("btnNextRound").onclick = () => nextRound();
document.getElementById("btnPlayAgain").onclick = () => resetGame();
document.getElementById("btnSaveRun").onclick = () => saveGame();

document.getElementById("btnSkill").onclick = () => levelUp();
document.getElementById("btnSave").onclick = () => saveGame();
document.getElementById("btnLoad").onclick = () => loadGame();
document.getElementById("btnReset").onclick = () => resetGame();

/* ====== BOOT ====== */
newGame();
document.getElementById("screen-intro").classList.add("active");
</script>
</body>
</html>
