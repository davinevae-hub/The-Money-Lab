<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Money Lab — Tap Card Game</title>
  <style>
    :root{
      --bg:#070a16;
      --text:#eef1ff;
      --muted:#aab3da;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --good:#5ee6a8;
      --bad:#ff6b7a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, var(--bg) 55%);
      color:var(--text);
      overflow-x:hidden;
    }
    header{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(7,10,22,.75);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
    }
    header .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width: 1100px; margin:0 auto;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    .brandDot{
      width:12px; height:12px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,.12);
      border:1px solid rgba(255,255,255,.12);
    }
    .sub{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.35; }
    main{ max-width:1100px; margin:0 auto; padding: 16px; }

    .hud{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-bottom: 14px;
    }
    @media (max-width: 980px){
      .hud{ grid-template-columns: repeat(3, 1fr); }
    }
    .kpi{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 62px;
    }
    .kpi .t{ font-size:11px; color:var(--muted); }
    .kpi .v{ margin-top:6px; font-weight:900; letter-spacing:.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
      min-height: 460px;
    }
    .side{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card{
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      padding: 14px;
    }
    .bigTitle{ font-size: 20px; font-weight: 950; margin: 0 0 6px; }
    .bigBody{ color: var(--muted); line-height: 1.45; }

    button{
      border-radius: 16px;
      border:1px solid rgba(122,162,255,.65);
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      color: var(--text);
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      width:100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-align:left;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight: 800;
    }
    button.danger{
      border-color: rgba(255,107,122,.65);
      background: linear-gradient(180deg, rgba(255,107,122,.95), rgba(255,107,122,.70));
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .btnRow .half{ flex:1 1 220px; }
    .btnRow .third{ flex:1 1 160px; }

    input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }

    .choiceGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (min-width: 860px){
      .choiceGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .tip{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      font-size: 12px;
      font-weight: 900;
      margin-right: 8px;
      margin-bottom: 8px;
      flex-wrap:wrap;
    }
    .avatarDot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05);
    }

    .progressWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
      height: 10px;
    }
    .progressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(94,230,168,.95), rgba(122,162,255,.95));
    }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      max-height: 360px;
      overflow:auto;
    }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }

    /* Screens */
    .screen{
      position:absolute;
      inset:0;
      padding: 14px;
      transform: translateX(110%);
      opacity: 0;
      transition: transform .35s ease, opacity .35s ease;
    }
    .screen.active{
      transform: translateX(0%);
      opacity: 1;
    }
    .screen.left{
      transform: translateX(-110%);
      opacity: 0;
    }

    ul.clean{ margin:10px 0 0 18px; color:var(--muted); }
    .billList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .billItem{
      display:flex; justify-content:space-between; gap:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .billItem strong{ color: var(--text); }

    .palette{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .colorPick{
      width:34px; height:34px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.20);
      position:relative;
    }
    .colorPick.selected::after{
      content:"";
      position:absolute; inset:7px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 0 3px rgba(255,255,255,.10);
    }

    /* Header controls */
    .headerControls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini{
      display:flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 8px 10px;
      border-radius: 999px;
      color:var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .toggle{
      width: 44px; height: 24px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .toggleKnob{
      position:absolute; top:3px; left:3px;
      width:18px; height:18px; border-radius:999px;
      background: rgba(255,255,255,.85);
      transition: left .15s ease, background .15s ease;
    }
    .toggle.on{
      background: rgba(94,230,168,.18);
      border-color: rgba(94,230,168,.35);
    }
    .toggle.on .toggleKnob{ left:23px; background: rgba(94,230,168,.95); }

    /* Confetti canvas */
    #confetti{
      position: fixed;
      inset:0;
      pointer-events:none;
      z-index:999;
    }

    /* SHOP */
    .shopGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (min-width: 860px){
      .shopGrid{ grid-template-columns: 1fr 1fr; }
    }
    .shopItem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 12px;
    }
    .shopTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .shopName{ font-weight:950; }
    .priceTag{
      font-weight:950;
      padding: 4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      white-space:nowrap;
    }
    .shopDesc{ color: var(--muted); font-size: 12px; line-height:1.35; margin-top:6px; }
    .previewBox{
      margin-top:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      padding: 10px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .swatchRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .swatch{
      width:18px; height:18px; border-radius:6px;
      border:1px solid rgba(255,255,255,.18);
    }
  </style>
</head>

<body>
<canvas id="confetti"></canvas>

<header>
  <div class="top">
    <div>
      <h1>
        <span class="brandDot" id="brandDot"></span>
        Money Lab — Tap Card Game
      </h1>
      <div class="sub">Quick rounds. Tap choices. Learn money basics.</div>
    </div>

    <div class="headerControls">
      <div class="mini">
        Sound
        <div class="toggle" id="soundToggle" role="switch" aria-checked="false" tabindex="0">
          <div class="toggleKnob"></div>
        </div>
      </div>

      <div class="mini" style="gap:10px;">
        <div>Seed</div>
        <input id="seed" type="text" placeholder="optional (ex: 2026)"
               style="width:170px; max-width:44vw; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18); color:var(--text); outline:none;" />
      </div>
    </div>
  </div>
</header>

<main>
  <section class="hud" aria-label="HUD">
    <div class="kpi"><div class="t">Round</div><div class="v" id="kRound">—</div></div>
    <div class="kpi"><div class="t">Level</div><div class="v" id="kLevel">—</div></div>
    <div class="kpi"><div class="t">Pocket</div><div class="v" id="kCash">—</div></div>
    <div class="kpi"><div class="t">Save Jar</div><div class="v" id="kSave">—</div></div>
    <div class="kpi"><div class="t">Grow Money</div><div class="v" id="kInv">—</div></div>
    <div class="kpi"><div class="t">Owe / Score</div><div class="v" id="kDebtScore">—</div></div>
    <div class="kpi"><div class="t">Points</div><div class="v" id="kPoints">—</div></div>
  </section>

  <div class="grid">
    <!-- MAIN -->
    <section class="panel" aria-label="App screens">
      <!-- INTRO -->
      <div class="screen" id="screen-intro">
        <div class="card">
          <div class="bigTitle">Welcome to Money Lab</div>
          <div class="bigBody">
            This is a quick money game.<br/>
            You’ll practice <strong>paying bills</strong>, <strong>saving</strong>, and <strong>growing money</strong>.
          </div>
          <div class="btnRow">
            <button class="half" id="btnIntroNext">Play</button>
            <button class="secondary half" id="btnIntroHow">How to play</button>
          </div>
          <div class="tip">You don’t need to be “good at math” to win. You just need a plan.</div>
        </div>
      </div>

      <!-- HOW -->
      <div class="screen" id="screen-how">
        <div class="card">
          <div class="bigTitle">How to play</div>

          <ul class="clean">
            <li>You get paid.</li>
            <li>You pay your bills.</li>
            <li>You pick a plan, then you get a surprise card.</li>
          </ul>

          <div class="tip">
            <strong>Your goal:</strong> keep bills paid, build savings, and try not to owe money.
          </div>

          <div class="tip">
            <strong>Plans:</strong><br/>
            Safe = save more<br/>
            Balanced = split money (save + grow)<br/>
            Bold = grow more (riskier)
          </div>

          <div class="btnRow">
            <button class="secondary half" id="btnHowBack">Back</button>
            <button class="half" id="btnHowNext">Next</button>
          </div>
        </div>
      </div>

      <!-- SETUP -->
      <div class="screen" id="screen-setup">
        <div class="card">
          <div class="bigTitle">Make your player</div>
          <div class="bigBody">Pick a name and a color. Then start.</div>

          <div style="margin-top:10px;">
            <div class="sub">Name</div>
            <input id="playerName" type="text" value="Player 1" />
          </div>

          <div style="margin-top:10px;">
            <div class="sub">Color</div>
            <div class="palette" id="palette"></div>
            <div class="tip">This is just for style. It doesn’t change the game.</div>
          </div>

          <div class="btnRow">
            <button class="secondary half" id="btnSetupBack">Back</button>
            <button class="half" id="btnSetupStart">Start</button>
          </div>
        </div>
      </div>

      <!-- START ROUND -->
      <div class="screen" id="screen-startRound">
        <div class="card">
          <div class="bigTitle">Ready for the next round?</div>
          <div class="bigBody">
            Tap <strong>Start Round</strong> to get paid and see your bills.
          </div>
          <div class="btnRow">
            <button class="half" id="btnStartRound">Start Round</button>
            <button class="secondary half" id="btnOpenShop1">Shop</button>
          </div>
          <div class="tip">Points come from smart choices and streaks. Spend points in the Shop for fun styles.</div>
        </div>
      </div>

      <!-- PAID + BILLS -->
      <div class="screen" id="screen-paidBills">
        <div class="card">
          <div class="bigTitle">You got paid</div>
          <div class="bigBody" id="paidText">—</div>

          <div class="hr"></div>

          <div class="bigTitle">Bills to pay</div>
          <div class="bigBody">These come out first.</div>
          <div class="billList" id="billList"></div>
          <div class="tip" id="billTotalTip">Total bills: —</div>

          <div class="btnRow">
            <button class="half" id="btnPaidContinue">Next</button>
          </div>
        </div>
      </div>

      <!-- PLAN -->
      <div class="screen" id="screen-plan">
        <div class="card">
          <div class="bigTitle">Pick a plan</div>
          <div class="bigBody" id="planPreview">—</div>

          <div class="choiceGrid">
            <button id="planSafe">
              <div>SAFE</div>
              <div class="sub">Save more. Grow a little. Keep it chill.</div>
            </button>
            <button id="planBalanced">
              <div>BALANCED</div>
              <div class="sub">Split it. Save some + grow some.</div>
            </button>
            <button id="planBold">
              <div>BOLD</div>
              <div class="sub">Grow more. Bigger risk.</div>
            </button>
          </div>

          <div class="tip">After you tap a plan, your Surprise card pops up.</div>
        </div>
      </div>

      <!-- SURPRISE -->
      <div class="screen" id="screen-surprise">
        <div class="card">
          <div class="bigTitle">Surprise card</div>
          <div class="bigBody" id="surpriseText">—</div>

          <div class="tip" id="surpriseHelp" style="display:none;">
            Surprise cards are random. Sometimes you gain money. Sometimes you lose money. Keep going.
          </div>

          <div class="choiceGrid" id="surpriseChoices" style="display:none;">
            <button id="btnGoOut">
              <div>Go out</div>
              <div class="sub" id="goOutCost">Costs —</div>
            </button>
            <button id="btnStayIn" class="secondary">
              <div>Stay in</div>
              <div class="sub">Costs $0</div>
            </button>
            <button class="secondary" disabled>
              <div>Pick one</div>
              <div class="sub">Then we move on.</div>
            </button>
          </div>

          <div class="tip" id="surpriseTip">Next, you’ll see how you did this round.</div>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="screen" id="screen-result">
        <div class="card">
          <div class="bigTitle">Round recap</div>
          <div class="bigBody" id="resultText">—</div>
          <div class="tip" id="resultTip">—</div>
          <div class="btnRow">
            <button class="half" id="btnNextRound">Next Round</button>
            <button class="secondary half" id="btnOpenShop2">Shop</button>
          </div>
        </div>
      </div>

      <!-- SHOP -->
      <div class="screen" id="screen-shop">
        <div class="card">
          <div class="bigTitle">Shop</div>
          <div class="bigBody">
            Spend points on fun upgrades (style only). This does not change your money.
          </div>

          <div class="previewBox">
            <div>
              <div style="font-weight:950;">Your points</div>
              <div class="sub">Buy themes and name titles.</div>
            </div>
            <div class="priceTag" id="shopPoints">—</div>
          </div>

          <div class="shopGrid" id="shopGrid"></div>

          <div class="btnRow">
            <button class="secondary half" id="btnShopBack">Back</button>
            <button class="danger half" id="btnShopReset">Reset Shop</button>
          </div>
          <div class="tip">Press Save to keep your unlocks on this device.</div>
        </div>
      </div>

      <!-- FINISH -->
      <div class="screen" id="screen-finish">
        <div class="card">
          <div class="bigTitle">Game over</div>
          <div class="bigBody" id="finishText">—</div>
          <div class="btnRow">
            <button class="danger half" id="btnPlayAgain">Play again</button>
            <button class="secondary half" id="btnSaveRun">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SIDE -->
    <section class="side" aria-label="Progress + Notes">
      <div class="card">
        <div class="pill" id="pillPlayer">
          <span class="avatarDot" id="avatarDot"></span>
          <span id="playerLabel">Player</span>
        </div>
        <div class="pill" id="pillStreak">Streak: 0</div>
        <div class="pill" id="pillGoal">Goal: —</div>
        <div class="pill">Points: <span id="pillPoints">0</span></div>

        <div class="progressWrap" aria-label="Progress">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="tip" id="tipBox">Tip: Save a little first. Future you will be grateful.</div>
      </div>

      <div class="hr"></div>

      <div class="card">
        <div class="bigTitle" style="font-size:16px;">What happened?</div>
        <div id="log" class="log"></div>
      </div>

      <div class="btnRow">
        <button class="secondary third" id="btnSkill">Level up</button>
        <button class="secondary third" id="btnSave">Save</button>
        <button class="secondary third" id="btnLoad">Load</button>
        <button class="danger third" id="btnReset">Reset</button>
      </div>
    </section>
  </div>
</main>

<script>
/* =========================================================
   MONEY LAB — Middle School Tone + Shop (single-file)
========================================================= */

/* ====== SETTINGS (game math) ====== */
const TOTAL_ROUNDS = 20;

const AVATAR_COLORS = ["#7aa2ff", "#5ee6a8", "#ff6b7a", "#ffd36a", "#b48cff", "#58e1ff"];

const BILLS_DECK = [
  { name: "Phone bill", min: 10, max: 35 },
  { name: "Transportation", min: 8, max: 30 },
  { name: "Lunch/snacks", min: 5, max: 22 },
  { name: "Subscription", min: 5, max: 15 },
  { name: "Supplies", min: 8, max: 25 },
  { name: "Family errand", min: 6, max: 20 }
];

const SAVINGS_GROWTH = 0.01;      // savings grows 1% per round
const INV_MIN = -0.06;            // investing can go down...
const INV_MAX =  0.12;            // ...or up
const DEBT_INTEREST = 0.03;       // debt grows 3% per round

const LEVELS = [
  { name: "Starter", perk: "You’re learning the basics.", cost: 0 },
  { name: "Saver",   perk: "Bad surprises hurt a little less.", cost: 250 },
  { name: "Planner", perk: "You get a small bonus each round.", cost: 350 },
  { name: "Investor",perk: "Your grow-money results are a bit better.", cost: 450 },
  { name: "Boss",    perk: "You lose less on rough days.", cost: 600 }
];

const PAYCHECKS = [
  { name: "Babysitting", min: 60, max: 140 },
  { name: "Part-time shift", min: 90, max: 180 },
  { name: "Gig job", min: 50, max: 220 },
  { name: "Small hustle", min: 40, max: 260 },
  { name: "Weekend work", min: 80, max: 210 }
];

const SURPRISES = [
  { name: "Cracked phone screen", kind:"cash", min:-70, max:-30, tip:"Stuff breaks. Savings helps." },
  { name: "Friend wants to go out", kind:"choice", cost:25, tip:"Fun is fine. Just plan for it." },
  { name: "Lost something", kind:"cash", min:-45, max:-15, tip:"Little losses add up." },
  { name: "Small bonus!", kind:"cash", min:25, max:80, tip:"Don’t waste wins. Build wins." },
  { name: "Market dip", kind:"market", min:-0.08, max:-0.03, tip:"Grow money can go down sometimes. That’s normal." },
  { name: "Market pop", kind:"market", min:0.03, max:0.10, tip:"Good days happen. Don’t get reckless." },
  { name: "Someone paid you back", kind:"cash", min:20, max:65, tip:"Save some when money comes back." },
  { name: "Unexpected bill", kind:"cash", min:-60, max:-20, tip:"Surprise bills are real. A buffer matters." }
];

const MICRO_TIPS = [
  "Save a little first. Future you will be grateful.",
  "Owing money grows if you ignore it.",
  "Grow money can go up or down. That’s normal.",
  "A plan beats guessing.",
  "Pocket money is for now. Save Jar is for later.",
  "One surprise can hurt if you have zero savings."
];

const GOALS = [
  { id: "save250", label: "Save $250 by Round 8", description: "Build a safety cushion early.",
    check: (s) => s.round >= 8 && s.savings >= 250 },
  { id: "noDebt10", label: "Owe $0 by Round 10", description: "Try not to owe money.",
    check: (s) => s.round >= 10 && s.debt === 0 },
  { id: "invest200", label: "Grow $200 by Round 8", description: "Put money into Grow Money early.",
    check: (s) => s.round >= 8 && s.invest >= 200 }
];

/* SHOP ITEMS (style only) */
const SHOP_ITEMS = [
  { id:"theme_midnight", type:"theme", name:"Theme: Midnight", price:60,
    desc:"Darker background vibe.", apply:()=>setTheme("midnight"), preview:{label:"Midnight", swatches:["#070a16","#1a2453","#7aa2ff"]}},
  { id:"theme_sunset", type:"theme", name:"Theme: Sunset", price:60,
    desc:"Warm background vibe.", apply:()=>setTheme("sunset"), preview:{label:"Sunset", swatches:["#1b0b16","#4a2042","#ffd36a"]}},
  { id:"theme_ocean", type:"theme", name:"Theme: Ocean", price:60,
    desc:"Cool blue background vibe.", apply:()=>setTheme("ocean"), preview:{label:"Ocean", swatches:["#07121a","#153a57","#58e1ff"]}},
  { id:"title_saver", type:"title", name:"Title: Saver", price:40,
    desc:"Adds “Saver” next to your name.", apply:()=>setTitle("Saver"), preview:{label:"Saver", swatches:["#5ee6a8"]}},
  { id:"title_investor", type:"title", name:"Title: Investor", price:40,
    desc:"Adds “Investor” next to your name.", apply:()=>setTitle("Investor"), preview:{label:"Investor", swatches:["#7aa2ff"]}},
  { id:"title_boss", type:"title", name:"Title: Boss", price:80,
    desc:"Adds “Boss” next to your name.", apply:()=>setTitle("Boss"), preview:{label:"Boss", swatches:["#ffd36a"]}}
];

const STORAGE_KEY = "moneyLab_middleSchool_shop_v1";

/* ====== UTIL ====== */
const fmt = (n) => {
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toLocaleString(undefined, { maximumFractionDigits: 0 });
};

function mulberry32(a){
  return function(){
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function getRoundRng(round){
  const s = document.getElementById("seed").value.trim();
  if(!s) return Math.random;
  const n = Number(s);
  if(!Number.isFinite(n)) return Math.random;
  return mulberry32((n + round * 101) >>> 0);
}
function rint(rng, min, max){ return Math.floor(rng() * (max - min + 1)) + min; }
function rfloat(rng, min, max){ return rng() * (max - min) + min; }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

/* ====== SOUND ====== */
let soundOn = false;
let audioCtx = null;

function ensureAudio(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
  }
}
function beep(freq=520, duration=0.06, type="sine", gain=0.05){
  if(!soundOn) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(gain, t0);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
  osc.connect(g).connect(audioCtx.destination);
  osc.start(t0);
  osc.stop(t0 + duration);
}
function sfxTap(){ beep(520, 0.05, "triangle", 0.04); }
function sfxWin(){ beep(740, 0.06, "sine", 0.05); setTimeout(()=>beep(980,0.07,"sine",0.05), 80); }
function sfxLose(){ beep(240, 0.07, "sine", 0.05); setTimeout(()=>beep(190,0.08,"sine",0.05), 90); }

/* ====== CONFETTI ====== */
const confettiCanvas = document.getElementById("confetti");
const conf = confettiCanvas.getContext("2d");
let confettiParticles = [];

function resizeConfetti(){
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeConfetti);
resizeConfetti();

function launchConfetti(intensity=120){
  const w = confettiCanvas.width, h = confettiCanvas.height;
  for(let i=0; i<intensity; i++){
    confettiParticles.push({
      x: Math.random() * w,
      y: -20 - Math.random() * h * 0.25,
      vx: (Math.random()-0.5) * 2.2,
      vy: 2.0 + Math.random() * 3.5,
      r: Math.random() * Math.PI,
      vr: (Math.random()-0.5) * 0.2,
      size: 5 + Math.random()*6,
      life: 220 + Math.random()*120,
      color: AVATAR_COLORS[Math.floor(Math.random()*AVATAR_COLORS.length)]
    });
  }
}
function stepConfetti(){
  const w = confettiCanvas.width, h = confettiCanvas.height;
  conf.clearRect(0,0,w,h);

  confettiParticles = confettiParticles.filter(p => p.life > 0);
  for(const p of confettiParticles){
    p.life -= 1;
    p.x += p.vx;
    p.y += p.vy;
    p.r += p.vr;
    p.vy += 0.01;
    if(p.y > h + 30) p.life = 0;

    conf.save();
    conf.translate(p.x, p.y);
    conf.rotate(p.r);
    conf.fillStyle = p.color;
    conf.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.7);
    conf.restore();
  }
  requestAnimationFrame(stepConfetti);
}
stepConfetti();

/* ====== THEMES (style only) ====== */
function setTheme(themeName){
  const b = document.body;
  if(themeName === "midnight"){
    b.style.background = "radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, #070a16 55%)";
  }else if(themeName === "sunset"){
    b.style.background = "radial-gradient(1200px 900px at 20% 10%, #4a2042 0%, #1b0b16 58%)";
  }else if(themeName === "ocean"){
    b.style.background = "radial-gradient(1200px 900px at 20% 10%, #153a57 0%, #07121a 58%)";
  }else{
    b.style.background = "radial-gradient(1200px 900px at 20% 10%, #1a2453 0%, #070a16 55%)";
  }
  state.cosmetics.activeTheme = themeName;
}

/* ====== TITLES (style only) ====== */
function setTitle(title){
  state.cosmetics.activeTitle = title;
  hud();
}

/* ====== STATE ====== */
let state = null;
let draft = null;

/* ====== UI HELPERS ====== */
function levelName(){ return LEVELS[clamp(state.level,0,LEVELS.length-1)].name; }

function moneyScore(){
  // Simple score: total money - owe + streak boost
  return Math.round((state.cash + state.savings + state.invest) - (state.debt * 1.2) + (state.streak * 10));
}

function log(line){
  state.log.push(line);
  const el = document.getElementById("log");
  el.textContent = state.log.join("\n");
  el.scrollTop = el.scrollHeight;
}

function setTip(text){
  document.getElementById("tipBox").textContent = "Tip: " + text;
}

function hud(){
  const score = moneyScore();

  document.getElementById("kRound").textContent = `${state.round}/${TOTAL_ROUNDS}`;
  document.getElementById("kLevel").textContent = `${levelName()} (Lv ${state.level+1})`;
  document.getElementById("kCash").textContent = fmt(state.cash);
  document.getElementById("kSave").textContent = fmt(state.savings);
  document.getElementById("kInv").textContent = fmt(state.invest);

  document.getElementById("kDebtScore").innerHTML =
    `<span class="${state.debt>0 ? "bad":"sub"}">${fmt(state.debt)}</span>
     <span class="sub"> / </span>
     <span class="${score>=0 ? "good":"bad"}">${fmt(score)}</span>`;

  document.getElementById("kPoints").textContent = String(state.points);
  document.getElementById("pillPoints").textContent = String(state.points);

  document.getElementById("pillStreak").textContent = `Streak: ${state.streak}`;

  const g = GOALS.find(x => x.id === state.goalId);
  document.getElementById("pillGoal").textContent = `Goal: ${g ? g.label : "—"}`;

  const title = state.cosmetics.activeTitle ? ` • ${state.cosmetics.activeTitle}` : "";
  document.getElementById("playerLabel").textContent = state.name + title;

  document.getElementById("avatarDot").style.background = state.avatarColor;
  document.getElementById("brandDot").style.background = state.avatarColor;

  const pct = Math.round((state.round-1) / TOTAL_ROUNDS * 100);
  document.getElementById("progressBar").style.width = `${pct}%`;

  const sp = document.getElementById("shopPoints");
  if(sp) sp.textContent = `${state.points} pts`;
}

/* ====== SCREEN NAV ====== */
let currentScreenId = "screen-intro";
let lastNonShopScreenId = "screen-startRound";

function go(screenId){
  const current = document.getElementById(currentScreenId);
  const next = document.getElementById(screenId);
  if(!current || !next) return;

  if(screenId !== "screen-shop"){
    lastNonShopScreenId = screenId;
  }

  current.classList.remove("active");
  current.classList.add("left");

  document.querySelectorAll(".screen").forEach(s => {
    if(s.id !== screenId && s.id !== currentScreenId){
      s.classList.remove("active");
      s.classList.remove("left");
    }
  });

  next.classList.add("active");
  next.classList.remove("left");

  setTimeout(() => current.classList.remove("left"), 360);
  currentScreenId = screenId;
}

/* ====== GAME MECHANICS ====== */
function plannerBonus(){ return (state.level >= 2) ? 10 : 0; }

function softenBadCost(amount){
  // amount is negative
  const reduce = 0.04 * state.level;
  return Math.round(amount * (1 - reduce));
}

function improveInvestPct(pct){
  return pct + 0.01 * state.level;
}

function buildBills(rng){
  const nBills = rint(rng, 2, 4);
  const picked = [];
  const used = new Set();
  while(picked.length < nBills){
    const b = BILLS_DECK[rint(rng, 0, BILLS_DECK.length - 1)];
    if(used.has(b.name)) continue;
    used.add(b.name);
    picked.push({ name: b.name, amount: rint(rng, b.min, b.max) });
  }
  const total = picked.reduce((s,x) => s + x.amount, 0);
  return { items: picked, total };
}

/* ====== POINTS ====== */
function addPoints(n, reason){
  const before = state.points;
  state.points = Math.max(0, state.points + n);
  if(n !== 0){
    log(`Points: ${before} → ${state.points} (${n>0?"+":""}${n}) ${reason ? "| " + reason : ""}`);
  }
}

/* ====== GOALS ====== */
function pickGoal(rng){
  const g = GOALS[rint(rng, 0, GOALS.length - 1)];
  return g.id;
}
function checkGoalCompletion(){
  if(state.goalCompleted) return false;
  const g = GOALS.find(x => x.id === state.goalId);
  if(!g) return false;
  if(g.check(state)){
    state.goalCompleted = true;
    return true;
  }
  return false;
}

/* ====== SHOP ====== */
function renderShop(){
  hud();
  const grid = document.getElementById("shopGrid");
  grid.innerHTML = "";

  SHOP_ITEMS.forEach(item => {
    const owned = !!state.cosmetics.owned[item.id];
    const isTheme = item.type === "theme";
    const isTitle = item.type === "title";
    const active =
      (isTheme && state.cosmetics.activeTheme === item.id.replace("theme_","")) ||
      (isTitle && state.cosmetics.activeTitle === item.name.replace("Title: ",""));

    const wrap = document.createElement("div");
    wrap.className = "shopItem";

    const swatches = (item.preview?.swatches || []).map(c => `<span class="swatch" style="background:${c}"></span>`).join("");

    wrap.innerHTML = `
      <div class="shopTop">
        <div>
          <div class="shopName">${item.name}${owned ? " (Owned)" : ""}</div>
          <div class="shopDesc">${item.desc}</div>
        </div>
        <div class="priceTag">${item.price} pts</div>
      </div>

      <div class="previewBox">
        <div>
          <div style="font-weight:950;">Preview: ${item.preview?.label || ""}</div>
          <div class="sub">${isTheme ? "Changes background" : "Adds a title"}</div>
        </div>
        <div class="swatchRow">${swatches}</div>
      </div>

      <div class="btnRow">
        <button class="half ${owned ? "secondary" : ""}" id="buy_${item.id}">
          ${owned ? (active ? "Using" : "Use") : "Buy"}
        </button>
        <button class="secondary half" id="preview_${item.id}">
          Preview
        </button>
      </div>
    `;
    grid.appendChild(wrap);

    const buyBtn = wrap.querySelector(`#buy_${item.id}`);
    buyBtn.disabled = (!owned && state.points < item.price);

    buyBtn.onclick = () => {
      sfxTap();
      if(!owned){
        if(state.points < item.price) return;
        state.points -= item.price;
        state.cosmetics.owned[item.id] = true;
        log(`Shop: Bought ${item.name} (-${item.price} pts)`);
        launchConfetti(90);
        sfxWin();
      }

      if(isTheme){
        const themeKey = item.id.replace("theme_","");
        setTheme(themeKey);
        log(`Shop: Theme set to ${item.preview?.label || themeKey}`);
      }else if(isTitle){
        const t = item.name.replace("Title: ","");
        setTitle(t);
        log(`Shop: Title set to ${t}`);
      }

      renderShop();
      hud();
    };

    const prevBtn = wrap.querySelector(`#preview_${item.id}`);
    prevBtn.onclick = () => {
      sfxTap();
      if(isTheme){
        const themeKey = item.id.replace("theme_","");
        setTheme(themeKey);
        setTip(`Previewing: ${item.preview?.label || themeKey}`);
      }else{
        setTip(`Preview only. Buy to keep: ${item.name}`);
      }
      hud();
    };
  });
}

function resetShop(){
  if(!confirm("Reset points and shop unlocks?")) return;
  state.points = 0;
  state.cosmetics.owned = {};
  state.cosmetics.activeTheme = "default";
  state.cosmetics.activeTitle = "";
  setTheme("default");
  setTitle("");
  log("Shop reset. Points and unlocks cleared.");
  renderShop();
  hud();
}

/* ====== NEW GAME ====== */
function newGame(){
  state = {
    name: "Player 1",
    avatarColor: AVATAR_COLORS[0],

    round: 1,
    level: 0,
    streak: 0,

    cash: 100,
    savings: 0,
    invest: 0,
    debt: 0,

    log: [],

    goalId: null,
    goalCompleted: false,

    points: 0,
    cosmetics: {
      owned: {},
      activeTheme: "default",
      activeTitle: ""
    },

    seenSurpriseHelp: false
  };

  draft = null;

  const rng = getRoundRng(1);
  state.goalId = pickGoal(rng);

  setTheme("default");
  setTip(MICRO_TIPS[0]);

  log("New game started. You begin with $100 in Pocket money.");
  const g = GOALS.find(x => x.id === state.goalId);
  if(g){
    log(`Goal card: ${g.label}`);
    log(`Goal hint: ${g.description}`);
  }

  hud();
  go("screen-intro");
}

/* ====== ROUND FLOW ====== */
function startRound(){
  const rng = getRoundRng(state.round);

  const job = PAYCHECKS[rint(rng, 0, PAYCHECKS.length - 1)];
  const paycheck = rint(rng, job.min, job.max);
  const bills = buildBills(rng);

  draft = {
    rng,
    jobName: job.name,
    paycheck,
    billsItems: bills.items,
    billsTotal: bills.total,

    planName: "",
    save: 0, invest: 0, spend: 0,

    surprise: null,
    surpriseText: "",
    choiceResult: null,

    beforeScore: moneyScore(),
    afterScore: null,

    saveBefore: null, saveAfter: null,
    invBefore: null, invAfter: null,
    invPct: 0
  };

  document.getElementById("paidText").innerHTML =
    `Job: <strong>${draft.jobName}</strong><br/>You earned: <strong>${fmt(draft.paycheck)}</strong>` +
    (plannerBonus() ? `<br/>Bonus: <strong>+${fmt(plannerBonus())}</strong>` : "");

  const list = document.getElementById("billList");
  list.innerHTML = "";
  draft.billsItems.forEach(b => {
    const div = document.createElement("div");
    div.className = "billItem";
    div.innerHTML = `<span>${b.name}</span><strong>${fmt(b.amount)}</strong>`;
    list.appendChild(div);
  });

  document.getElementById("billTotalTip").innerHTML = `Total bills: <strong>${fmt(draft.billsTotal)}</strong>`;

  sfxTap();
  go("screen-paidBills");
}

function applyPlan(planKey){
  // 1) Get paid
  state.cash += draft.paycheck + plannerBonus();

  // 2) Pay bills
  const billCost = draft.billsTotal;
  if(state.cash >= billCost){
    state.cash -= billCost;
  }else{
    const gap = billCost - state.cash;
    state.cash = 0;
    state.debt += gap;
  }

  // 3) Split what’s left
  const available = state.cash;

  let saveP=0.50, invP=0.20;
  if(planKey === "balanced"){ saveP=0.35; invP=0.35; }
  if(planKey === "bold"){ saveP=0.20; invP=0.55; }

  const save = Math.round(available * saveP);
  const inv  = Math.round(available * invP);
  const spend= Math.max(0, available - save - inv);

  state.cash -= (save + inv + spend);
  state.savings += save;
  state.invest += inv;

  draft.planName = (planKey === "safe" ? "Safe" : planKey === "balanced" ? "Balanced" : "Bold");
  draft.save = save; draft.invest = inv; draft.spend = spend;

  // Points (simple rewards)
  if(planKey === "safe") addPoints(3, "Picked Safe");
  if(planKey === "balanced") addPoints(2, "Picked Balanced");
  if(planKey === "bold") addPoints(1, "Picked Bold");
  if(save > 0) addPoints(1, "Saved something");

  sfxTap();

  drawSurprise();
  setTimeout(() => go("screen-surprise"), 220);
}

function drawSurprise(){
  const s = SURPRISES[rint(draft.rng, 0, SURPRISES.length - 1)];
  draft.surprise = s;

  document.getElementById("surpriseChoices").style.display = "none";
  document.getElementById("surpriseTip").textContent = "Next, you’ll see your recap.";

  if(s.kind === "cash"){
    let impact = rint(draft.rng, s.min, s.max);
    if(impact < 0) impact = softenBadCost(impact);

    draft.surpriseText = (impact >= 0)
      ? `You gained ${fmt(impact)}.`
      : `You lost ${fmt(-impact)}.`;

    if(impact >= 0){
      state.cash += impact;
      addPoints(1, "Bonus moment");
    }else{
      const cost = -impact;
      if(state.cash >= cost){
        state.cash -= cost;
      }else{
        const gap = cost - state.cash;
        state.cash = 0;
        state.debt += gap;
      }
    }
  }

  if(s.kind === "market"){
    let pct = improveInvestPct(rfloat(draft.rng, s.min, s.max));
    draft.surpriseText = `Your Grow Money changed by ${(pct*100).toFixed(1)}%.`;
    state.invest = Math.round(state.invest * (1 + pct));
    addPoints(1, "Stayed in the game");
  }

  if(s.kind === "choice"){
    draft.surpriseText = `Do you want to go out for ${fmt(s.cost)}?`;
    document.getElementById("surpriseChoices").style.display = "grid";
    document.getElementById("goOutCost").textContent = `Costs ${fmt(s.cost)}`;
    document.getElementById("surpriseTip").textContent = "Pick one. Then we move on.";
  }

  document.getElementById("surpriseText").innerHTML =
    `<strong>${s.name}</strong><br/>${draft.surpriseText}`;

  // First-time help
  const help = document.getElementById("surpriseHelp");
  if(!state.seenSurpriseHelp){
    help.style.display = "block";
    state.seenSurpriseHelp = true;
  }else{
    help.style.display = "none";
  }

  hud();
}

function resolveChoice(choice){
  const s = draft.surprise;
  if(!s || s.kind !== "choice") return;

  const cost = s.cost;

  if(choice === "go"){
    if(state.cash >= cost){
      state.cash -= cost;
      draft.choiceResult = `You went out. (-${fmt(cost)})`;
    }else{
      const gap = cost - state.cash;
      state.cash = 0;
      state.debt += gap;
      draft.choiceResult = `You went out, but you didn’t have enough. You now owe ${fmt(gap)}.`;
    }
  }else{
    draft.choiceResult = "You stayed in. ($0)";
    addPoints(2, "Stayed in (saved money)");
  }

  sfxTap();
  setTimeout(() => showResults(), 320);
}

function applyGrowthAndInterest(){
  draft.saveBefore = state.savings;
  state.savings = Math.round(state.savings * (1 + SAVINGS_GROWTH));
  draft.saveAfter = state.savings;

  const pct = improveInvestPct(rfloat(draft.rng, INV_MIN, INV_MAX));
  draft.invPct = pct;
  draft.invBefore = state.invest;
  state.invest = Math.round(state.invest * (1 + pct));
  draft.invAfter = state.invest;

  if(state.debt > 0){
    state.debt = Math.round(state.debt * (1 + DEBT_INTEREST));
  }
}

function showResults(){
  if(draft.surprise && draft.surprise.kind === "choice" && !draft.choiceResult) return;

  applyGrowthAndInterest();

  const after = moneyScore();
  draft.afterScore = after;

  // streak: “good round” = not much debt pressure
  const goodRound = (state.debt === 0) || (draft.planName !== "Bold" && state.debt < 200);
  state.streak = goodRound ? state.streak + 1 : 0;

  const delta = after - draft.beforeScore;
  const cls = delta >= 0 ? "good" : "bad";

  document.getElementById("resultText").innerHTML = `
    Score change: <strong class="${cls}">${delta>=0?"+":""}${fmt(delta)}</strong><br/>
    Plan: <strong>${draft.planName}</strong><br/>
    You saved: <strong>${fmt(draft.save)}</strong> • You grew: <strong>${fmt(draft.invest)}</strong> • You spent: <strong>${fmt(draft.spend)}</strong><br/>
    ${draft.choiceResult ? `Choice: <strong>${draft.choiceResult}</strong><br/>` : ""}
    Save Jar grew: <strong>${fmt(draft.saveBefore)} → ${fmt(draft.saveAfter)}</strong><br/>
    Grow Money moved: <strong>${(draft.invPct*100).toFixed(1)}%</strong> (${fmt(draft.invBefore)} → ${fmt(draft.invAfter)})
  `;

  const tip = draft.surprise?.tip || MICRO_TIPS[rint(draft.rng, 0, MICRO_TIPS.length - 1)];
  document.getElementById("resultTip").textContent = "Tip: " + tip;
  setTip(tip);

  // Ledger (simple)
  log(`\nROUND ${state.round}/${TOTAL_ROUNDS}`);
  log(`You earned: +${fmt(draft.paycheck)} (${draft.jobName})${plannerBonus() ? ` + Bonus ${fmt(plannerBonus())}` : ""}`);
  log(`Bills paid: -${fmt(draft.billsTotal)}`);
  log(`Plan: ${draft.planName} | Saved ${fmt(draft.save)} | Grew ${fmt(draft.invest)} | Spent ${fmt(draft.spend)}`);
  if(draft.surprise) log(`Surprise: ${draft.surprise.name} — ${draft.surpriseText}`);
  if(draft.choiceResult) log(`Choice: ${draft.choiceResult}`);
  if(state.debt > 0) log(`You owe: ${fmt(state.debt)}`);
  log(`Score now: ${fmt(after)} | Streak: ${state.streak}`);

  // points for score change
  if(delta > 0){ addPoints(2, "Score went up"); sfxWin(); }
  else { sfxLose(); }

  // streak reward
  if(state.streak === 3 || state.streak === 5 || state.streak === 10){
    addPoints(5, `Streak ${state.streak}`);
    launchConfetti(160);
    sfxWin();
  }

  // goal complete
  const justCompletedGoal = checkGoalCompletion();
  if(justCompletedGoal){
    addPoints(10, "Goal complete");
    launchConfetti(220);
    sfxWin();
    setTip("Goal complete! Nice work.");
  }

  hud();
  go("screen-result");
}

function nextRound(){
  state.round += 1;
  draft = null;

  if(state.round > TOTAL_ROUNDS){
    const score = moneyScore();
    document.getElementById("finishText").innerHTML =
      `You finished <strong>${TOTAL_ROUNDS}</strong> rounds.<br/>
       Final score: <strong class="${score>=0?"good":"bad"}">${fmt(score)}</strong><br/>
       Goal: <strong>${state.goalCompleted ? "Completed" : "Not completed (try again)"}.</strong><br/>
       Points: <strong>${state.points}</strong>`;
    go("screen-finish");
    return;
  }

  hud();
  go("screen-startRound");
}

/* ====== LEVEL UP ====== */
function levelUp(){
  if(state.level >= LEVELS.length - 1) return;
  const next = state.level + 1;
  const cost = LEVELS[next].cost;

  if(state.cash < cost){
    alert(`You need ${fmt(cost)} in Pocket money to level up.`);
    return;
  }

  state.cash -= cost;
  state.level = next;

  log(`Level up: ${LEVELS[state.level].name} (-${fmt(cost)})`);
  log(`Perk: ${LEVELS[state.level].perk}`);

  setTip(LEVELS[state.level].perk);
  addPoints(2, "Leveled up");
  sfxTap();
  hud();
}

/* ====== SAVE/LOAD ====== */
function saveGame(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ state, soundOn }));
  log("Saved on this device.");
  sfxTap();
}
function loadGame(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert("No saved game found."); return; }
  try{
    const parsed = JSON.parse(raw);
    state = parsed.state;
    soundOn = !!parsed.soundOn;
    setSoundUI();
    draft = null;

    setTheme(state.cosmetics.activeTheme || "default");
    setTitle(state.cosmetics.activeTitle || "");

    hud();
    log("\nLoaded saved game.");
    go("screen-startRound");
  }catch(e){
    alert("Could not load the save.");
  }
}
function resetGame(){
  if(!confirm("Reset the whole game?")) return;
  document.getElementById("log").textContent = "";
  newGame();
}

/* ====== AVATAR PALETTE ====== */
function buildPalette(){
  const p = document.getElementById("palette");
  p.innerHTML = "";
  AVATAR_COLORS.forEach((c, idx) => {
    const d = document.createElement("div");
    d.className = "colorPick";
    d.style.background = c;
    d.title = c;
    d.onclick = () => {
      sfxTap();
      state.avatarColor = c;
      document.querySelectorAll(".colorPick").forEach(x => x.classList.remove("selected"));
      d.classList.add("selected");
      hud();
    };
    if(idx === 0) d.classList.add("selected");
    p.appendChild(d);
  });
}

/* ====== SOUND TOGGLE UI ====== */
function setSoundUI(){
  const el = document.getElementById("soundToggle");
  if(soundOn){
    el.classList.add("on");
    el.setAttribute("aria-checked", "true");
  }else{
    el.classList.remove("on");
    el.setAttribute("aria-checked", "false");
  }
}
function toggleSound(){
  soundOn = !soundOn;
  setSoundUI();
  if(soundOn){
    ensureAudio();
    sfxTap();
  }
}

/* ====== BUTTONS ====== */
document.getElementById("btnIntroNext").onclick = () => { sfxTap(); go("screen-setup"); };
document.getElementById("btnIntroHow").onclick = () => { sfxTap(); go("screen-how"); };

document.getElementById("btnHowBack").onclick = () => { sfxTap(); go("screen-intro"); };
document.getElementById("btnHowNext").onclick = () => { sfxTap(); go("screen-setup"); };

document.getElementById("btnSetupBack").onclick = () => { sfxTap(); go("screen-intro"); };
document.getElementById("btnSetupStart").onclick = () => {
  state.name = (document.getElementById("playerName").value.trim() || "Player 1");
  log(`Player name set: ${state.name}`);
  hud();
  sfxTap();
  go("screen-startRound");
};

document.getElementById("btnStartRound").onclick = () => startRound();

document.getElementById("btnPaidContinue").onclick = () => {
  const after = Math.max(0, state.cash + draft.paycheck + plannerBonus() - draft.billsTotal);
  document.getElementById("planPreview").innerHTML =
    `After bills, you’ll have about <strong>${fmt(after)}</strong> to split. Pick a plan:`;
  sfxTap();
  go("screen-plan");
};

document.getElementById("planSafe").onclick = () => applyPlan("safe");
document.getElementById("planBalanced").onclick = () => applyPlan("balanced");
document.getElementById("planBold").onclick = () => applyPlan("bold");

document.getElementById("btnGoOut").onclick = () => resolveChoice("go");
document.getElementById("btnStayIn").onclick = () => resolveChoice("stay");

/* Auto-advance from surprise to recap if there is no choice */
const surpriseObserver = new MutationObserver(() => {
  if(!draft || !draft.surprise) return;
  if(draft.surprise.kind !== "choice"){
    setTimeout(() => showResults(), 800);
  }
});
surpriseObserver.observe(document.getElementById("surpriseText"), { childList:true, subtree:true });

document.getElementById("btnNextRound").onclick = () => { sfxTap(); nextRound(); };
document.getElementById("btnPlayAgain").onclick = () => resetGame();
document.getElementById("btnSaveRun").onclick = () => saveGame();

document.getElementById("btnSkill").onclick = () => levelUp();
document.getElementById("btnSave").onclick = () => saveGame();
document.getElementById("btnLoad").onclick = () => loadGame();
document.getElementById("btnReset").onclick = () => resetGame();

document.getElementById("soundToggle").onclick = () => toggleSound();
document.getElementById("soundToggle").addEventListener("keydown", (e) => {
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    toggleSound();
  }
});

/* Shop navigation */
function openShop(){
  sfxTap();
  renderShop();
  go("screen-shop");
}
document.getElementById("btnOpenShop1").onclick = openShop;
document.getElementById("btnOpenShop2").onclick = openShop;

document.getElementById("btnShopBack").onclick = () => { sfxTap(); go(lastNonShopScreenId); };
document.getElementById("btnShopReset").onclick = () => resetShop();

/* ====== BOOT ====== */
newGame();
buildPalette();
document.getElementById("screen-intro").classList.add("active");
setSoundUI();
hud();
renderShop();
</script>
</body>
</html>
